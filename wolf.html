<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Áãº‰∫∫ÊùÄ ¬∑ ÂçïÊú∫Áâà</title>
<link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #1a0f00;
  --ink2: #2d1a05;
  --parchment: #f4e9d0;
  --parchment2: #e8d8b0;
  --parchment3: #d4c090;
  --red: #8b1a1a;
  --red2: #c0392b;
  --gold: #8b6914;
  --gold2: #c8921a;
  --blue-ink: #1a3a5c;
  --green-ink: #1a4a2a;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Noto Serif SC', serif;
  background: #0d0800;
  min-height: 100vh;
  color: var(--ink);
  overflow-x: hidden;
}

/* ===== SCREENS ===== */
.screen { display:none; min-height:100vh; }
#s-title.active {
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  background: radial-gradient(ellipse at 50% 40%, #2d1a05 0%, #0d0800 100%);
  padding:40px 20px; text-align:center;
}
#s-game.active {
  display:flex; flex-direction:column;
  background: linear-gradient(135deg, #1a0e04 0%, #0d0800 50%, #1a0a04 100%);
  max-width:700px; margin:0 auto;
}

/* ===== TITLE ===== */
.title-scroll {
  background: linear-gradient(180deg, #e8d5a0 0%, #f0e4b8 30%, #f0e4b8 70%, #e8d5a0 100%);
  border: 3px solid var(--gold);
  padding: 50px 60px;
  max-width: 460px; width: 100%;
  position: relative;
  box-shadow: 0 0 60px rgba(139,105,20,0.3), inset 0 0 40px rgba(200,146,26,0.1);
}
.title-scroll::before, .title-scroll::after {
  content:''; position:absolute; left:-12px; right:-12px; height:28px;
  background: linear-gradient(180deg, #8b6914, #c8921a, #8b6914);
  border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,0.4);
}
.title-scroll::before { top:-13px; }
.title-scroll::after  { bottom:-13px; }

.title-eyebrow { font-size:11px; letter-spacing:0.5em; color:var(--gold); margin-bottom:16px; }

h1.main-title {
  font-family: 'Ma Shan Zheng', cursive;
  font-size: clamp(52px,15vw,88px);
  color: var(--red);
  text-shadow: 2px 2px 0 rgba(139,26,26,0.3), 4px 4px 8px rgba(0,0,0,0.2);
  letter-spacing:0.15em; line-height:1; margin-bottom:8px;
}
.title-sub {
  font-size:12px; color:var(--gold); letter-spacing:0.3em;
  border-top:1px solid var(--gold); border-bottom:1px solid var(--gold);
  padding:8px 0; margin-bottom:28px;
}
.title-seal { font-size:48px; margin-bottom:20px; animation:sealBreath 3s ease-in-out infinite alternate; }
@keyframes sealBreath {
  from { transform:scale(0.96) rotate(-2deg); filter:drop-shadow(0 0 8px rgba(139,26,26,0.4)); }
  to   { transform:scale(1.04) rotate(2deg);  filter:drop-shadow(0 0 20px rgba(139,26,26,0.7)); }
}
.title-flavor { font-size:13px; color:var(--ink2); line-height:1.8; margin-bottom:28px; font-style:italic; }

.diff-label { font-size:12px; color:var(--gold); margin-bottom:10px; letter-spacing:0.2em; }
.diff-row { display:flex; gap:8px; justify-content:center; margin-bottom:24px; }
.diff-btn {
  background:none; border:1px solid var(--gold);
  font-family:'Noto Serif SC',serif; font-size:12px;
  padding:8px 16px; cursor:pointer; color:var(--ink2);
  transition:all 0.2s; letter-spacing:0.1em;
}
.diff-btn.active, .diff-btn:hover { background:var(--gold); color:var(--parchment); }

.start-btn {
  background:var(--red); border:2px solid var(--red2);
  color:var(--parchment); font-family:'Ma Shan Zheng',cursive;
  font-size:22px; padding:14px 48px; cursor:pointer; letter-spacing:0.3em;
  transition:all 0.2s; display:inline-block;
  clip-path:polygon(10px 0,100% 0,calc(100% - 10px) 100%,0 100%);
  box-shadow:0 4px 20px rgba(139,26,26,0.4);
}
.start-btn:hover { background:var(--red2); transform:translateY(-2px); }
.start-btn:active { transform:translateY(0); }

/* ===== GAME HEADER ===== */
.game-hdr {
  background: linear-gradient(90deg,#2d1a05,#1a0f00,#2d1a05);
  border-bottom:2px solid var(--gold);
  padding:10px 20px;
  display:flex; align-items:center; justify-content:space-between;
  position:sticky; top:0; z-index:10;
}
.phase-indicator { font-family:'Ma Shan Zheng',cursive; font-size:22px; letter-spacing:0.3em; }
.phase-indicator.night { color:#a0c8ff; text-shadow:0 0 15px rgba(160,200,255,0.5); }
.phase-indicator.day   { color:#ffd080; text-shadow:0 0 15px rgba(255,208,128,0.5); }
.round-badge {
  background:rgba(139,105,20,0.2); border:1px solid var(--gold);
  padding:4px 12px; font-size:12px; color:var(--gold); letter-spacing:0.15em;
}

/* ===== PLAYERS GRID ===== */
.village-table {
  background:linear-gradient(135deg,#e8d5a0,#f0e4b8,#e0cc90);
  border:3px solid var(--gold); margin:16px;
  padding:20px 16px; position:relative;
  box-shadow:inset 0 0 30px rgba(139,105,20,0.15),0 4px 20px rgba(0,0,0,0.5);
}
.village-table::before {
  content:'üèòÔ∏è ÊùëÂ∫ÑËÆÆ‰∫ãÂè∞';
  position:absolute; top:-13px; left:50%; transform:translateX(-50%);
  background:var(--parchment2); border:1px solid var(--gold);
  padding:2px 14px; font-size:11px; color:var(--gold); letter-spacing:0.2em; white-space:nowrap;
}
.players-ring {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(88px,1fr));
  gap:10px; margin-top:4px;
}
.player-card {
  background:linear-gradient(180deg,#fdf5e0,#f5e8c0);
  border:2px solid var(--parchment3);
  padding:10px 6px 8px; text-align:center;
  position:relative; transition:all 0.2s;
  box-shadow:2px 2px 6px rgba(0,0,0,0.15);
  cursor:default; user-select:none;
}
.player-card.is-you {
  border-color:var(--gold2);
  box-shadow:0 0 0 2px rgba(200,146,26,0.3),2px 2px 6px rgba(0,0,0,0.15);
}
.player-card.selectable { cursor:pointer; border-color:var(--red); }
.player-card.selectable:hover {
  transform:translateY(-3px) scale(1.03);
  box-shadow:0 6px 16px rgba(139,26,26,0.3);
  border-color:var(--red2);
  background:linear-gradient(180deg,#fff0e0,#ffe0c0);
}
.player-card.selected {
  border-color:var(--red2); background:linear-gradient(180deg,#ffe8e0,#ffd0c0);
  box-shadow:0 0 0 3px rgba(192,57,43,0.4); transform:translateY(-3px);
}
.player-card.dead { opacity:0.35; cursor:default; filter:grayscale(0.5); }
.player-card.dead .death-mark {
  position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
  font-size:36px; color:var(--red); opacity:0.6; pointer-events:none;
}
.pc-seat  { font-size:9px; color:var(--gold); margin-bottom:3px; letter-spacing:0.1em; }
.pc-avatar{ font-size:26px; line-height:1; margin-bottom:4px; }
.pc-name  { font-size:11px; color:var(--ink); font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.pc-role  { font-size:9px; margin-top:3px; padding:1px 6px; display:inline-block; }
.pc-role.wolf    { background:rgba(139,26,26,0.15); color:var(--red); border:1px solid rgba(139,26,26,0.3); }
.pc-role.village { background:rgba(26,74,42,0.15); color:var(--green-ink); border:1px solid rgba(26,74,42,0.3); }
.you-badge {
  position:absolute; top:-8px; right:4px;
  background:var(--gold); color:var(--parchment); font-size:8px; padding:1px 5px;
}

/* ===== SPEECH LOG ===== */
.speech-log {
  background:linear-gradient(180deg,#1a0f00,#0d0800);
  border:1px solid rgba(139,105,20,0.3);
  margin:0 16px; padding:14px;
  max-height:260px; overflow-y:auto;
  display:flex; flex-direction:column; gap:10px;
}
.speech-log::-webkit-scrollbar { width:3px; }
.speech-log::-webkit-scrollbar-thumb { background:var(--gold); }

.speech-item { display:flex; gap:10px; align-items:flex-start; animation:speechIn 0.35s ease-out; }
@keyframes speechIn { from{opacity:0;transform:translateX(-10px)} to{opacity:1;transform:translateX(0)} }
.speech-item.right { flex-direction:row-reverse; }
.speech-item.system { justify-content:center; }

.speech-avatar-sm { font-size:22px; flex-shrink:0; }

.bubble { max-width:75%; padding:8px 12px; line-height:1.6; font-size:13px; }
.speech-item:not(.right):not(.system) .bubble {
  background:linear-gradient(135deg,#f0e4b8,#e8d8a0); color:var(--ink);
  border:1px solid var(--parchment3); border-radius:0 8px 8px 8px;
}
.speech-item.right .bubble {
  background:linear-gradient(135deg,#3a1a08,#2a1205); color:#e8d5b0;
  border:1px solid rgba(200,146,26,0.3); border-radius:8px 0 8px 8px;
}
.speech-item.system .bubble {
  background:rgba(139,26,26,0.15); border:1px solid rgba(139,26,26,0.3);
  color:#e0a080; font-size:12px; letter-spacing:0.05em;
  text-align:center; border-radius:4px; width:100%;
}
.bubble-name { font-size:10px; margin-bottom:3px; opacity:0.7; font-weight:700; }
.speech-item.right .bubble-name { text-align:right; }

/* ===== ACTION PANEL ===== */
.action-panel {
  background:linear-gradient(180deg,#e8d5a0,#dcc888);
  border:2px solid var(--gold); margin:16px; padding:16px;
}
.action-title {
  font-size:14px; color:var(--red); letter-spacing:0.3em;
  margin-bottom:10px; border-bottom:1px solid var(--gold2); padding-bottom:6px;
}
.skill-res { display:flex; gap:8px; font-size:12px; color:var(--gold); margin-bottom:8px; }
.skill-pip { padding:2px 8px; border:1px solid var(--gold2); background:rgba(139,105,20,0.15); }
.skill-pip.used { opacity:0.3; text-decoration:line-through; }
.action-desc { font-size:13px; color:var(--ink2); line-height:1.8; margin-bottom:12px; min-height:20px; }
.action-btns { display:flex; gap:8px; flex-wrap:wrap; }

.ink-btn {
  background:var(--ink); border:1px solid var(--gold);
  color:var(--parchment); font-family:'Noto Serif SC',serif;
  font-size:13px; padding:8px 20px; cursor:pointer;
  letter-spacing:0.1em; transition:all 0.2s;
  clip-path:polygon(6px 0,100% 0,calc(100% - 6px) 100%,0 100%);
}
.ink-btn:hover { background:var(--red); border-color:var(--red2); transform:translateY(-1px); }
.ink-btn:active { transform:translateY(0); }
.ink-btn.gold { background:var(--gold); border-color:var(--gold2); color:var(--ink); }
.ink-btn.gold:hover { background:var(--gold2); }

/* ===== MODAL OVERLAY (shared for role reveal, night info, alerts) ===== */
.modal-overlay {
  position:fixed; inset:0; z-index:200;
  background:rgba(5,2,0,0.9);
  display:none; align-items:center; justify-content:center;
  backdrop-filter:blur(4px);
}
.modal-overlay.open { display:flex; }

.modal-box {
  background:linear-gradient(160deg,#f5e8c0,#ecdba0,#f0e4b8);
  border:4px solid var(--gold); padding:36px 44px;
  max-width:380px; width:90%; text-align:center; position:relative;
  box-shadow:0 0 60px rgba(139,105,20,0.5);
  animation:modalIn 0.4s cubic-bezier(0.175,0.885,0.32,1.275);
}
@keyframes modalIn { from{opacity:0;transform:scale(0.7) rotate(-4deg)} to{opacity:1;transform:scale(1) rotate(0)} }
.modal-box::before, .modal-box::after {
  content:''; position:absolute; left:-8px; right:-8px; height:22px;
  background:linear-gradient(90deg,var(--gold),var(--gold2),var(--gold));
}
.modal-box::before { top:-10px; }
.modal-box::after  { bottom:-10px; }

/* Night-mode modal */
.modal-box.night-mode {
  background:linear-gradient(160deg,#080520,#050318);
  border-color:#4040a0;
  box-shadow:0 0 60px rgba(80,80,200,0.4);
}
.modal-box.night-mode::before, .modal-box.night-mode::after {
  background:linear-gradient(90deg,#2020a0,#6060d0,#2020a0);
}

.modal-icon  { font-size:64px; margin-bottom:12px; animation:iconPop 0.5s 0.2s ease-out both; }
@keyframes iconPop { from{transform:scale(0)} to{transform:scale(1)} }
.modal-team  { font-size:11px; letter-spacing:0.4em; margin-bottom:12px; }
.modal-team.wolf    { color:var(--red); }
.modal-team.village { color:var(--green-ink); }
.modal-team.night   { color:#8080ff; }
.modal-title { font-family:'Ma Shan Zheng',cursive; font-size:36px; letter-spacing:0.2em; margin-bottom:8px; }
.modal-title.wolf    { color:var(--red); }
.modal-title.village { color:var(--blue-ink); }
.modal-title.night   { color:#a0a0ff; }
.modal-divider { border:none; border-top:1px solid var(--gold2); margin:10px 0; }
.modal-divider.night { border-color:#3030a0; }
.modal-desc  { font-size:13px; color:var(--ink2); line-height:1.8; margin-bottom:10px; }
.modal-desc.night { color:#8090c0; }
.modal-skill { background:rgba(26,15,0,0.08); border:1px solid rgba(139,105,20,0.3); padding:10px 14px; font-size:12px; color:var(--ink2); margin-bottom:20px; text-align:left; line-height:1.6; }
.modal-skill.night { background:rgba(0,0,30,0.5); border-color:#2020a0; color:#8090c0; }
.modal-secret { background:rgba(0,0,30,0.6); border:1px solid rgba(80,80,200,0.3); padding:16px 24px; margin:16px 0; }
.modal-secret-label { font-size:10px; color:#6070a0; letter-spacing:0.3em; margin-bottom:8px; }
.modal-secret-value { font-size:20px; color:#c0c8ff; font-family:'Ma Shan Zheng',cursive; letter-spacing:0.15em; }
.modal-btns  { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:4px; }

/* ===== WIN SCREEN ===== */
#win-screen {
  position:fixed; inset:0; z-index:300;
  display:none; flex-direction:column; align-items:center; justify-content:center;
  text-align:center; padding:30px;
}
#win-screen.wolf-win    { background:radial-gradient(ellipse,#3a0808,#0d0200); }
#win-screen.village-win { background:radial-gradient(ellipse,#1a3020,#050d08); }
#win-screen.open { display:flex; }

.win-icon  { font-size:80px; margin-bottom:16px; animation:winPulse 1.5s ease-in-out infinite alternate; }
@keyframes winPulse { from{transform:scale(0.9);filter:drop-shadow(0 0 10px gold)} to{transform:scale(1.1);filter:drop-shadow(0 0 40px gold)} }
.win-title { font-family:'Ma Shan Zheng',cursive; font-size:52px; letter-spacing:0.3em; margin-bottom:10px; }
.wolf-win .win-title    { color:#ff6060; text-shadow:0 0 30px rgba(255,96,96,0.7); }
.village-win .win-title { color:#80e0a0; text-shadow:0 0 30px rgba(128,224,160,0.7); }
.win-sub   { color:#aaa; font-size:14px; margin-bottom:24px; }
.reveal-list { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:28px; max-width:420px; }
.reveal-chip { background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); padding:6px 14px; font-size:12px; color:#ddd; }
</style>
</head>
<body>

<!-- ===== TITLE ===== -->
<div id="s-title" class="screen">
  <div class="title-scroll">
    <div class="title-eyebrow">¬∑ Âçï‰∫∫ÊåëÊàò ¬∑ ‰∫∫Êú∫ÂØπÊàò ¬∑</div>
    <div class="title-seal">üê∫</div>
    <h1 class="main-title">Áãº‰∫∫ÊùÄ</h1>
    <div class="title-sub">Â§úËâ≤‰∏≠ÁöÑÁúüÁõ∏</div>
    <div class="title-flavor">ÈªëÂ§úÈôç‰∏¥ÔºåÁãº‰∫∫ÈÜíÊù•„ÄÇ<br>‰Ω†ËÉΩÊâæÂá∫ÊΩú‰ºèÂú®ÊùëÂ∫Ñ‰∏≠ÁöÑÊÅ∂È≠îÂêóÔºü<br>ËøòÊòØËØ¥Ôºå‰Ω†Â∞±ÊòØÈÇ£Â§¥Êä´ÁùÄÁæäÁöÆÁöÑÁãº‚Ä¶‚Ä¶</div>
    <div class="diff-label">ÈÄâÊã©ÈöæÂ∫¶</div>
    <div class="diff-row">
      <button class="diff-btn active" id="diff-easy">ÁÆÄÂçï<br><span style="font-size:10px">6‰∫∫Â±Ä</span></button>
      <button class="diff-btn" id="diff-normal">ÊôÆÈÄö<br><span style="font-size:10px">8‰∫∫Â±Ä</span></button>
      <button class="diff-btn" id="diff-hard">Âõ∞Èöæ<br><span style="font-size:10px">10‰∫∫Â±Ä</span></button>
    </div>
    <button class="start-btn" id="btn-start">ÂÖ•Êùë</button>
  </div>
</div>

<!-- ===== GAME ===== -->
<div id="s-game" class="screen">
  <div class="game-hdr">
    <div class="phase-indicator night" id="phase-indicator">üåë ÈªëÂ§ú</div>
    <div class="round-badge" id="round-badge">Á¨¨ 1 Â§ú</div>
  </div>
  <div class="village-table">
    <div class="players-ring" id="players-ring"></div>
  </div>
  <div class="speech-log" id="speech-log"></div>
  <div class="action-panel">
    <div class="action-title" id="action-title">‚óà Á≠âÂæÖ‰∏≠</div>
    <div class="skill-res" id="skill-res"></div>
    <div class="action-desc" id="action-desc"></div>
    <div class="action-btns" id="action-btns"></div>
  </div>
</div>

<!-- ===== MODAL (single shared overlay) ===== -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal-box" id="modal-box">
    <div class="modal-icon"  id="modal-icon">üê∫</div>
    <div class="modal-team"  id="modal-team"></div>
    <div class="modal-title" id="modal-title"></div>
    <hr class="modal-divider" id="modal-divider">
    <div class="modal-desc"  id="modal-desc"></div>
    <div class="modal-skill" id="modal-skill" style="display:none"></div>
    <div class="modal-secret" id="modal-secret" style="display:none">
      <div class="modal-secret-label" id="modal-secret-label"></div>
      <div class="modal-secret-value" id="modal-secret-value"></div>
    </div>
    <div class="modal-btns"  id="modal-btns"></div>
  </div>
</div>

<!-- ===== WIN ===== -->
<div id="win-screen">
  <div class="win-icon"  id="win-icon">üèÜ</div>
  <div class="win-title" id="win-title">Ê∏∏ÊàèÁªìÊùü</div>
  <div class="win-sub"   id="win-sub"></div>
  <div class="reveal-list" id="reveal-list"></div>
  <button class="start-btn" id="btn-replay">ÂÜçÊù•‰∏ÄÂ±Ä</button>
</div>

<script>
// ============================================================
// DATA
// ============================================================
const ROLES = {
  wolf:     { name:'Áãº‰∫∫',  icon:'üê∫', team:'wolf',    skill:'ÊØèÂ§ú‰∏éÁãºÈòüÂïÜËÆÆÂêéÂáªÊùÄ‰∏ÄÂêçÁé©ÂÆ∂„ÄÇÁôΩÂ§©‰º™Ë£ÖË∫´‰ªΩÂèÇ‰∏éÊäïÁ•®„ÄÇ' },
  seer:     { name:'È¢ÑË®ÄÂÆ∂',icon:'üîÆ', team:'village', skill:'ÊØèÂ§úÂèØÊü•È™å‰∏ÄÂêçÁé©ÂÆ∂Ë∫´‰ªΩÔºàÁãº‰∫∫/Â•Ω‰∫∫Ôºâ„ÄÇ' },
  witch:    { name:'Â•≥Â∑´',  icon:'‚öóÔ∏è', team:'village', skill:'Êã•ÊúâËß£ËçØ√ó1ÔºàÊïëÂΩìÊôöË¢´ÊùÄËÄÖÔºâÂíåÊØíËçØ√ó1ÔºàÊØíÊùÄ‰ªªÊÑèÁé©ÂÆ∂Ôºâ„ÄÇ' },
  guard:    { name:'ÂÆàÂç´',  icon:'üõ°Ô∏è', team:'village', skill:'ÊØèÂ§úÂÆàÊä§‰∏ÄÂêçÁé©ÂÆ∂ÂÖçÂèóÁãºÊùÄÔºå‰∏çÂèØËøûÁª≠ÂÆàÊä§Âêå‰∏Ä‰∫∫„ÄÇ' },
  hunter:   { name:'Áåé‰∫∫',  icon:'üî´', team:'village', skill:'Ê≠ª‰∫°Êó∂ÂèØÂºÄÊû™Â∏¶Ëµ∞‰∏ÄÂêçÁé©ÂÆ∂ÔºàË¢´ÊØíÊ≠ªÊó∂Êó†ÊïàÔºâ„ÄÇ' },
  villager: { name:'ÊùëÊ∞ë',  icon:'üßë‚Äçüåæ',team:'village', skill:'Âá≠Êô∫ÊÖßÂú®ÁôΩÂ§©ÊâæÂá∫Áãº‰∫∫Âπ∂ÊäïÁ•®È©±ÈÄê„ÄÇ' },
};

const CONFIGS = {
  easy:   { total:6,  wolves:2, seer:1, witch:1, guard:0, hunter:0 },
  normal: { total:8,  wolves:2, seer:1, witch:1, guard:1, hunter:0 },
  hard:   { total:10, wolves:3, seer:1, witch:1, guard:1, hunter:1 },
};

const WOLF_SAYS = [
  'ÊàëÊò®ÊôöÁù°ÂæóÂæàÂÆâÁ®≥Ôºå‰ªÄ‰πàÈÉΩ‰∏çÁü•ÈÅì„ÄÇ',
  'Â§ßÂÆ∂ÂÜ∑ÈùôÂàÜÊûêÔºå‰∏çË¶ÅÈöèÊÑè‰π±ÊäïÁ•®„ÄÇ',
  'ÊàëËßâÂæóÊàë‰ª¨Â∫îËØ•Â§öÂê¨Âê¨È¢ÑË®ÄÂÆ∂ÁöÑÁ∫øÁ¥¢„ÄÇ',
  'ÊÑüËßâÊúâ‰∫õÁé©ÂÆ∂ÁöÑÂèëË®ÄÈÄªËæëÂæàÂ•áÊÄ™‚Ä¶',
  'ÊàëÊòØÂ•Ω‰∫∫ÔºåËØ∑Â§ßÂÆ∂Áõ∏‰ø°Êàë„ÄÇ',
];
const GOOD_SAYS = [
  'Êò®ÊôöÂπ≥ÂÆâÔºåÊàëÊ≤°ÊúâÂèëÁé∞‰ªª‰ΩïÂºÇÂ∏∏„ÄÇ',
  'Êàë‰ª¨Ë¶ÅÊâæÂá∫ÈÄªËæëÁ†¥ÁªΩÔºå‰∏çËÉΩ‰π±Êäï„ÄÇ',
  'Ê≥®ÊÑèËßÇÂØüË∞ÅÁöÑÂèëË®ÄÂâçÂêéÁüõÁõæ„ÄÇ',
  'ÊàëÊîØÊåÅÂ§ßÂÆ∂ÁêÜÊÄßËÆ®ËÆ∫ÔºåÊâæÂá∫ÂÜÖÈ¨º„ÄÇ',
  'Âõ¢Áªì‰∏ÄËá¥ÔºåÊàë‰ª¨‰∏ÄÂÆöËÉΩËµ¢ÔºÅ',
];

const NPC_NAMES   = ['ÈòøÊòé','Êôì‰∫ë','Â§ßÂ£Æ','ÁßÄËã±','ÈòøËôé','ÂÜ¨Ê¢Ö','ËÄÅÈìÅ','Â∞èËä±','ÈòøÈ£û','Âª∫ÂõΩ','Áø†Ëé≤','Â§ßÂàö'];
const NPC_AVATARS = ['üë®','üë©','üë¥','üëµ','üßë','üë±','üßî','üë≤','üßï','üë®‚Äçü¶±','üë©‚Äçü¶±','üßí'];

// ============================================================
// STATE
// ============================================================
let difficulty = 'easy';
let G = null; // game state, null until started

// ============================================================
// HELPERS
// ============================================================
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
function rnd(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ============================================================
// MODAL (single overlay, used for everything)
// ============================================================
function showModal({ icon='', team='', title='', desc='', skill=null, secret=null, night=false, buttons=[] }) {
  const box = document.getElementById('modal-box');
  box.className = 'modal-box' + (night ? ' night-mode' : '');

  document.getElementById('modal-icon').textContent  = icon;
  document.getElementById('modal-team').textContent  = team;
  document.getElementById('modal-team').className    = 'modal-team ' + (night ? 'night' : (team.includes('Áãº') ? 'wolf' : 'village'));
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-title').className   = 'modal-title ' + (night ? 'night' : (team.includes('Áãº') ? 'wolf' : 'village'));
  document.getElementById('modal-divider').className = 'modal-divider' + (night ? ' night' : '');
  document.getElementById('modal-desc').textContent  = desc;
  document.getElementById('modal-desc').className    = 'modal-desc' + (night ? ' night' : '');

  const skillEl = document.getElementById('modal-skill');
  if (skill) {
    skillEl.style.display = 'block';
    skillEl.innerHTML = '<strong>‚ö° ÊäÄËÉΩÔºö</strong>' + skill;
    skillEl.className = 'modal-skill' + (night ? ' night' : '');
  } else {
    skillEl.style.display = 'none';
  }

  const secretEl = document.getElementById('modal-secret');
  if (secret) {
    secretEl.style.display = 'block';
    document.getElementById('modal-secret-label').textContent = secret.label || '';
    document.getElementById('modal-secret-value').textContent = secret.value || '';
  } else {
    secretEl.style.display = 'none';
  }

  const btnsEl = document.getElementById('modal-btns');
  btnsEl.innerHTML = '';
  buttons.forEach(({ text, gold, fn }) => {
    const btn = document.createElement('button');
    btn.className = 'ink-btn' + (gold ? ' gold' : '');
    btn.textContent = text;
    btn.addEventListener('click', fn);
    btnsEl.appendChild(btn);
  });

  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
}

// ============================================================
// RENDER PLAYERS
// ============================================================
function renderPlayers(selectableFilter) {
  // selectableFilter: fn(player) => bool, or null for no selection
  const ring = document.getElementById('players-ring');
  ring.innerHTML = '';
  G.players.forEach(p => {
    const rd = ROLES[p.role];
    const div = document.createElement('div');

    const canSelect = selectableFilter && p.alive && selectableFilter(p);
    const isSelected = G.selectedId === p.id;

    let cls = 'player-card';
    if (p.isHuman)  cls += ' is-you';
    if (!p.alive)   cls += ' dead';
    if (canSelect)  cls += ' selectable';
    if (isSelected) cls += ' selected';
    div.className = cls;

    // Show role only for human or dead
    const showRole = p.isHuman || !p.alive;

    div.innerHTML = `
      ${p.isHuman ? '<div class="you-badge">‰Ω†</div>' : ''}
      <div class="pc-seat">${p.seat}Âè∑</div>
      <div class="pc-avatar">${p.avatar}</div>
      <div class="pc-name">${p.name}</div>
      ${showRole ? `<div class="pc-role ${rd.team}">${rd.icon}${rd.name}</div>` : ''}
      ${!p.alive ? '<div class="death-mark">‚Ä†</div>' : ''}
    `;

    if (canSelect) {
      div.addEventListener('click', () => {
        G.selectedId = p.id;
        renderPlayers(selectableFilter);
      });
    }
    ring.appendChild(div);
  });
}

// ============================================================
// SPEECH LOG
// ============================================================
function addSpeech(player, text) {
  const log = document.getElementById('speech-log');
  const div = document.createElement('div');
  div.className = 'speech-item' + (player.isHuman ? ' right' : '');
  div.innerHTML = `
    ${!player.isHuman ? `<div class="speech-avatar-sm">${player.avatar}</div>` : ''}
    <div class="bubble">
      <div class="bubble-name">${player.seat}Âè∑ ${player.name}</div>
      ${text}
    </div>
    ${player.isHuman ? `<div class="speech-avatar-sm">${player.avatar}</div>` : ''}
  `;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function addSystem(text) {
  const log = document.getElementById('speech-log');
  const div = document.createElement('div');
  div.className = 'speech-item system';
  div.innerHTML = `<div class="bubble">${text}</div>`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

// ============================================================
// ACTION PANEL
// ============================================================
function setAction({ title='', skill=null, desc='', buttons=[] }) {
  document.getElementById('action-title').textContent = '‚óà ' + title;
  document.getElementById('action-desc').textContent  = desc;

  const skillRes = document.getElementById('skill-res');
  if (skill) {
    skillRes.style.display = 'flex';
    skillRes.innerHTML = skill;
  } else {
    skillRes.style.display = 'none';
    skillRes.innerHTML = '';
  }

  const btns = document.getElementById('action-btns');
  btns.innerHTML = '';
  buttons.forEach(({ text, gold, fn }) => {
    const btn = document.createElement('button');
    btn.className = 'ink-btn' + (gold ? ' gold' : '');
    btn.textContent = text;
    btn.addEventListener('click', fn);
    btns.appendChild(btn);
  });
}

function clearAction() {
  setAction({ title:'Á≠âÂæÖ‰∏≠', desc:'', buttons:[] });
  renderPlayers(null);
}

function flashDesc(msg) {
  const el = document.getElementById('action-desc');
  const old = el.textContent;
  el.style.color = '#c0392b';
  el.textContent = '‚ö†Ô∏è ' + msg;
  setTimeout(() => { el.style.color = ''; el.textContent = old; }, 1800);
}

function updateHeader() {
  const ind = document.getElementById('phase-indicator');
  const badge = document.getElementById('round-badge');
  if (G.phase === 'night') {
    ind.textContent = 'üåë ÈªëÂ§ú';
    ind.className = 'phase-indicator night';
    badge.textContent = `Á¨¨ ${G.round} Â§ú`;
  } else {
    ind.textContent = '‚òÄÔ∏è ÁôΩÂ§©';
    ind.className = 'phase-indicator day';
    badge.textContent = `Á¨¨ ${G.round} Â§©`;
  }
}

// ============================================================
// INIT GAME
// ============================================================
function initGame() {
  const cfg = CONFIGS[difficulty];
  const total = cfg.total;

  let roles = [];
  for (let i = 0; i < cfg.wolves; i++) roles.push('wolf');
  roles.push('seer');
  roles.push('witch');
  if (cfg.guard)  roles.push('guard');
  if (cfg.hunter) roles.push('hunter');
  while (roles.length < total) roles.push('villager');
  roles = shuffle(roles);

  const humanIdx = Math.floor(Math.random() * total);
  const names    = shuffle([...NPC_NAMES]).slice(0, total);
  const avatars  = shuffle([...NPC_AVATARS]).slice(0, total);

  G = {
    players: [],
    humanIdx,
    round: 1,
    phase: 'night',
    // Night state (reset each night)
    wolfKill: null,
    witchSave: false,
    witchPoison: null,
    witchPoisonedTarget: false, // witch used poison (for hunter check)
    guardProtect: null,
    guardLastProtect: null,
    // Persistent witch resources
    witchUsedSave: false,
    witchUsedPoison: false,
    // UI
    selectedId: null,
  };

  for (let i = 0; i < total; i++) {
    G.players.push({
      id: i, seat: i + 1,
      name: i === humanIdx ? '‰Ω†' : names[i],
      avatar: avatars[i],
      role: roles[i],
      alive: true,
      isHuman: i === humanIdx,
    });
  }

  document.getElementById('speech-log').innerHTML = '';
  showScreen('s-game');
  updateHeader();
  renderPlayers(null);

  // Show role card once
  showRoleCard();
}

// ============================================================
// ROLE REVEAL (shown once at game start)
// ============================================================
function showRoleCard() {
  const human = G.players[G.humanIdx];
  const rd = ROLES[human.role];
  const isWolf = rd.team === 'wolf';

  showModal({
    icon: rd.icon,
    team: isWolf ? '¬∑ Áãº‰∫∫ÈòµËê• ¬∑' : '¬∑ Â•Ω‰∫∫ÈòµËê• ¬∑',
    title: rd.name,
    desc: isWolf
      ? '‰Ω†ÊòØÁãº‰∫∫ÔºÅÊΩú‰ºèÂú®ÊùëÂ∫Ñ‰∏≠ÔºåÊ∂àÁÅ≠ÊâÄÊúâÂ•Ω‰∫∫„ÄÇ'
      : `‰Ω†ÊòØ${rd.name}ÔºåËøêÁî®‰Ω†ÁöÑÂäõÈáèÂ∏ÆÂä©ÊùëÂ∫ÑÊâæÂá∫Áãº‰∫∫ÔºÅ`,
    skill: rd.skill,
    night: false,
    buttons: [{
      text: 'ÊàëÂ∑≤Áü•ÊôìÔºåËøõÂÖ•Ê∏∏Êàè', gold: true,
      fn: () => { closeModal(); beginNight(); }
    }]
  });
}

// ============================================================
// NIGHT PHASE
// ============================================================
function beginNight() {
  G.phase = 'night';
  G.wolfKill = null;
  G.witchSave = false;
  G.witchPoison = null;
  G.witchPoisonedTarget = false;
  G.guardProtect = null;
  G.selectedId = null;
  updateHeader();
  clearAction();
  addSystem(`‚îÅ‚îÅ‚îÅ‚îÅ Á¨¨ ${G.round} Â§ú ‚îÅ‚îÅ‚îÅ‚îÅ`);

  // Build the sequence of night actions for this round
  const steps = buildNightSteps();
  runNightStep(steps, 0);
}

function buildNightSteps() {
  const steps = [];
  // Wolves always act
  steps.push('wolf');
  // Only add steps if that role is alive
  if (G.players.some(p => p.alive && p.role === 'seer'))  steps.push('seer');
  if (G.players.some(p => p.alive && p.role === 'witch'))  steps.push('witch');
  if (G.players.some(p => p.alive && p.role === 'guard'))  steps.push('guard');
  return steps;
}

function runNightStep(steps, idx) {
  // All steps done ‚Üí resolve
  if (idx >= steps.length) {
    resolveNight();
    return;
  }

  const step = steps[idx];
  const next = () => runNightStep(steps, idx + 1);
  const human = G.players[G.humanIdx];

  if (step === 'wolf') {
    if (human.alive && human.role === 'wolf') {
      nightWolfHuman(next);
    } else {
      aiWolfKill();
      next();
    }

  } else if (step === 'seer') {
    if (human.alive && human.role === 'seer') {
      nightSeerHuman(next);
    } else {
      aiSeer();
      next();
    }

  } else if (step === 'witch') {
    if (human.alive && human.role === 'witch') {
      nightWitchHuman(next);
    } else {
      aiWitch();
      next();
    }

  } else if (step === 'guard') {
    if (human.alive && human.role === 'guard') {
      nightGuardHuman(next);
    } else {
      aiGuard();
      next();
    }
  }
}

// ---- Wolf (human) ----
function nightWolfHuman(next) {
  const human = G.players[G.humanIdx];
  const wolfTeam = G.players.filter(p => p.role === 'wolf').map(p => p.id);

  showModal({
    icon: 'üê∫', team: '¬∑ Áãº‰∫∫Ë°åÂä® ¬∑', title: 'ÈªëÂ§úÈôç‰∏¥',
    desc: '‰Ω†ÊòØÁãº‰∫∫„ÄÇÂÖ≥Èó≠Ê≠§Á™óÂè£ÂêéÔºåËØ∑ÈÄâÊã©‰ªäÊôöË¶ÅÂáªÊùÄÁöÑÁõÆÊ†á„ÄÇ',
    night: true,
    buttons: [{
      text: 'Â•ΩÁöÑ', fn: () => {
        closeModal();
        G.selectedId = null;
        // Exclude self + wolf teammates from selection
        renderPlayers(p => !wolfTeam.includes(p.id));
        setAction({
          title: 'üê∫ Áãº‰∫∫ÂáªÊùÄ',
          desc: 'ËØ∑ÈÄâÊã©‰ªäÊôöË¶ÅÂáªÊùÄÁöÑÁõÆÊ†áÔºà‰∏çËÉΩÈÄâËá™Â∑±ÊàñÁãºÈòüÂèãÔºâ',
          buttons: [
            { text: 'Á°ÆËÆ§ÂáªÊùÄ', fn: () => {
              if (G.selectedId === null) { flashDesc('ËØ∑ÂÖàÁÇπÂáª‰∏ÄÂêçÁõÆÊ†áÁé©ÂÆ∂'); return; }
              G.wolfKill = G.selectedId;
              G.selectedId = null;
              clearAction();
              next();
            }},
            { text: 'ÊîæÂºÉÂáªÊùÄ', fn: () => {
              G.wolfKill = null;
              G.selectedId = null;
              clearAction();
              next();
            }},
          ]
        });
      }
    }]
  });
}

// ---- Seer (human) ----
function nightSeerHuman(next) {
  const human = G.players[G.humanIdx];

  showModal({
    icon: 'üîÆ', team: '¬∑ È¢ÑË®ÄÂÆ∂Ë°åÂä® ¬∑', title: 'Á•ûÁßòÊÑüÂ∫î',
    desc: 'ÂÖ≥Èó≠ÂêéËØ∑ÈÄâÊã©‰∏ÄÂêçÁé©ÂÆ∂Êü•È™åÂÖ∂Ë∫´‰ªΩ„ÄÇ',
    night: true,
    buttons: [{
      text: 'Â•ΩÁöÑ', fn: () => {
        closeModal();
        G.selectedId = null;
        renderPlayers(p => p.id !== human.id);
        setAction({
          title: 'üîÆ È¢ÑË®ÄÂÆ∂Êü•È™å',
          desc: 'ËØ∑ÈÄâÊã©‰∏ÄÂêçÁé©ÂÆ∂Êü•È™åÂÖ∂Ë∫´‰ªΩÔºà‰∏çËÉΩÈÄâËá™Â∑±Ôºâ',
          buttons: [
            { text: 'Á°ÆËÆ§Êü•È™å', fn: () => {
              if (G.selectedId === null) { flashDesc('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÊü•È™åÁöÑÁé©ÂÆ∂'); return; }
              const target = G.players[G.selectedId];
              const isWolf = target.role === 'wolf';
              const resultText = isWolf ? 'üî¥ Áãº‰∫∫' : 'üîµ Â•Ω‰∫∫';
              G.selectedId = null;
              clearAction();
              // Show result in a modal, then continue
              showModal({
                icon: 'üîÆ', team: 'Êü•È™åÁªìÊûú', title: 'Â§©ÁúºÊè≠Á§∫',
                night: true,
                desc: `${target.seat}Âè∑ ${target.name} ÁöÑË∫´‰ªΩÊòØÔºö`,
                secret: { label: target.name, value: resultText },
                buttons: [{
                  text: 'Êî∂Âà∞ÔºåÂÖ≥Èó≠', fn: () => { closeModal(); next(); }
                }]
              });
            }},
            { text: 'Ë∑≥Ëøá', fn: () => {
              G.selectedId = null;
              clearAction();
              next();
            }},
          ]
        });
      }
    }]
  });
}

// ---- Witch (human) ----
function nightWitchHuman(next) {
  const killed = G.wolfKill !== null ? G.players[G.wolfKill] : null;
  const canSave   = !G.witchUsedSave && killed !== null;
  const canPoison = !G.witchUsedPoison;

  const skillHtml = `
    <div class="skill-pip ${G.witchUsedSave ? 'used' : ''}">üíäËß£ËçØ ${G.witchUsedSave ? 'Â∑≤Áî®' : '√ó1'}</div>
    <div class="skill-pip ${G.witchUsedPoison ? 'used' : ''}">‚ò†Ô∏èÊØíËçØ ${G.witchUsedPoison ? 'Â∑≤Áî®' : '√ó1'}</div>
  `;

  let descText = killed
    ? `‰ªäÊôö ${killed.name} Ë¢´Áãº‰∫∫ÂáªÊùÄ„ÄÇ`
    : '‰ªäÊôöÁãº‰∫∫Ê≤°ÊúâÂáªÊùÄ‰ªª‰Ωï‰∫∫„ÄÇ';
  if (canSave)   descText += ` ‰Ω†ÂèØ‰ª•‰ΩøÁî®Ëß£ËçØÊïëÊ¥ª ${killed.name}„ÄÇ`;
  if (canPoison) descText += ' ‰Ω†ÂèØ‰ª•‰ΩøÁî®ÊØíËçØÊØíÊùÄ‰ªªÊÑèÁé©ÂÆ∂„ÄÇ';
  if (!canSave && !canPoison) descText += ' ‰Ω†ÁöÑËçØÊ∞¥Â∑≤ËÄóÂ∞Ω„ÄÇ';

  const buttons = [];
  if (canSave) {
    buttons.push({ text: `üíä Êïë ${killed.name}`, fn: () => {
      G.witchSave = true;
      G.witchUsedSave = true;
      addSystem(`Â•≥Â∑´‰ΩøÁî®Ëß£ËçØÊïë‰∫Ü ${killed.name}`);
      closeModal();
      // After save, check if can still poison
      if (!G.witchUsedPoison) {
        nightWitchPoison(next);
      } else {
        clearAction();
        next();
      }
    }});
  }
  if (canPoison) {
    buttons.push({ text: '‚ò†Ô∏è ‰ΩøÁî®ÊØíËçØ', fn: () => {
      closeModal();
      nightWitchPoison(next);
    }});
  }
  buttons.push({ text: '‰ªÄ‰πàÈÉΩ‰∏çÂÅö', fn: () => {
    closeModal();
    clearAction();
    next();
  }});

  showModal({
    icon: '‚öóÔ∏è', team: '¬∑ Â•≥Â∑´Ë°åÂä® ¬∑', title: 'ËçØÂâÇÊó∂Âàª',
    desc: descText, skill: skillHtml, night: true,
    buttons
  });
}

function nightWitchPoison(next) {
  const human = G.players[G.humanIdx];
  G.selectedId = null;
  renderPlayers(p => p.id !== human.id);
  setAction({
    title: '‚öóÔ∏è Â•≥Â∑´ ¬∑ ÊØíËçØ',
    skill: `<div class="skill-pip">‚ò†Ô∏èÊØíËçØ √ó1</div>`,
    desc: 'ÈÄâÊã©‰∏ÄÂêçÁé©ÂÆ∂‰ΩøÁî®ÊØíËçØÔºàÊàñË∑≥Ëøá‰∏çÁî®Ôºâ',
    buttons: [
      { text: 'Á°ÆËÆ§ÊØíÊùÄ', fn: () => {
        if (G.selectedId === null) { flashDesc('ËØ∑ÂÖàÈÄâÊã©ÊØíÊùÄÁõÆÊ†á'); return; }
        G.witchPoison = G.selectedId;
        G.witchUsedPoison = true;
        G.witchPoisonedTarget = true;
        addSystem(`Â•≥Â∑´‰ΩøÁî®‰∫ÜÊØíËçØ‚Ä¶`);
        G.selectedId = null;
        clearAction();
        next();
      }},
      { text: '‰∏çÁî®ÊØíËçØ', fn: () => {
        G.selectedId = null;
        clearAction();
        next();
      }},
    ]
  });
}

// ---- Guard (human) ----
function nightGuardHuman(next) {
  const human = G.players[G.humanIdx];

  showModal({
    icon: 'üõ°Ô∏è', team: '¬∑ ÂÆàÂç´Ë°åÂä® ¬∑', title: 'ÂÆàÂ§ú',
    desc: 'ÂÖ≥Èó≠ÂêéËØ∑ÈÄâÊã©‰∏ÄÂêçÁé©ÂÆ∂ËøõË°åÂÆàÊä§Ôºà‰∏çÂèØËøûÁª≠ÂÆàÊä§Âêå‰∏Ä‰∫∫Ôºâ„ÄÇ',
    night: true,
    buttons: [{
      text: 'Â•ΩÁöÑ', fn: () => {
        closeModal();
        G.selectedId = null;
        renderPlayers(p => p.id !== human.id);
        setAction({
          title: 'üõ°Ô∏è ÂÆàÂç´ÂÆàÊä§',
          desc: 'ËØ∑ÈÄâÊã©Ë¶ÅÂÆàÊä§ÁöÑÁé©ÂÆ∂Ôºà‰∏çÂèØËøûÁª≠ÂÆàÊä§Âêå‰∏Ä‰∫∫Ôºâ',
          buttons: [
            { text: 'Á°ÆËÆ§ÂÆàÊä§', fn: () => {
              if (G.selectedId === null) { flashDesc('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÂÆàÊä§ÁöÑÁé©ÂÆ∂'); return; }
              if (G.selectedId === G.guardLastProtect) { flashDesc('‰∏çËÉΩËøûÁª≠‰∏§Â§úÂÆàÊä§Âêå‰∏Ä‰∫∫ÔºÅ'); return; }
              G.guardProtect = G.selectedId;
              G.guardLastProtect = G.selectedId;
              G.selectedId = null;
              clearAction();
              next();
            }},
            { text: 'Ë∑≥Ëøá', fn: () => {
              G.selectedId = null;
              clearAction();
              next();
            }},
          ]
        });
      }
    }]
  });
}

// ---- AI Actions ----
function aiWolfKill() {
  const targets = G.players.filter(p => p.alive && p.role !== 'wolf');
  if (!targets.length) return;
  // Prefer key roles
  const priority = targets.filter(p => ['seer','witch','guard','hunter'].includes(p.role));
  G.wolfKill = (priority.length > 0 && Math.random() < 0.55)
    ? rnd(priority).id : rnd(targets).id;
}

function aiSeer() {
  const seer = G.players.find(p => p.alive && p.role === 'seer' && !p.isHuman);
  if (!seer) return;
  // AI seer just checks someone - no visible effect for player
}

function aiWitch() {
  const witch = G.players.find(p => p.alive && p.role === 'witch' && !p.isHuman);
  if (!witch) return;
  if (!G.witchUsedSave && G.wolfKill !== null && Math.random() < 0.65) {
    G.witchSave = true;
    G.witchUsedSave = true;
  } else if (!G.witchUsedPoison && G.round > 1 && Math.random() < 0.25) {
    const targets = G.players.filter(p => p.alive && p.id !== witch.id);
    if (targets.length) {
      G.witchPoison = rnd(targets).id;
      G.witchUsedPoison = true;
      G.witchPoisonedTarget = true;
    }
  }
}

function aiGuard() {
  const guard = G.players.find(p => p.alive && p.role === 'guard' && !p.isHuman);
  if (!guard) return;
  const targets = G.players.filter(p => p.alive && p.id !== G.guardLastProtect);
  if (!targets.length) return;
  G.guardProtect = rnd(targets).id;
  G.guardLastProtect = G.guardProtect;
}

// ============================================================
// RESOLVE NIGHT
// ============================================================
function resolveNight() {
  const deaths = [];

  // Wolf kill - check guard + witch save
  if (G.wolfKill !== null) {
    const guardSaved = G.guardProtect === G.wolfKill;
    const witchSaved = G.witchSave;
    if (!guardSaved && !witchSaved) deaths.push(G.wolfKill);
  }

  // Witch poison (not blocked by guard)
  if (G.witchPoison !== null && !deaths.includes(G.witchPoison)) {
    deaths.push(G.witchPoison);
  }

  deaths.forEach(id => { G.players[id].alive = false; });

  const deathNames = deaths.map(id => G.players[id].name);
  const msg = deaths.length === 0
    ? '‚òÄÔ∏è Âπ≥ÂÆâÂ§úÔºÅ‰ªäÊôöÊ≤°ÊúâÁé©ÂÆ∂Ê≠ª‰∫°„ÄÇ'
    : `‚òÄÔ∏è ÈªéÊòéÊù•‰∏¥„ÄÇ${deathNames.join('„ÄÅ')} ÂÄíÂú®‰∫ÜÈªëÂ§ú‰πã‰∏≠„ÄÇ`;
  addSystem(msg);

  if (checkWin()) return;

  // Hunter night death (not if poisoned)
  const nightHunter = deaths.find(id => {
    return G.players[id].role === 'hunter' && G.witchPoison !== id;
  });

  renderPlayers(null);

  if (nightHunter !== undefined) {
    handleHunter(nightHunter, () => beginDay());
  } else {
    beginDay();
  }
}

// ============================================================
// DAY PHASE
// ============================================================
function beginDay() {
  G.phase = 'day';
  G.selectedId = null;
  updateHeader();
  clearAction();
  addSystem(`‚îÅ‚îÅ‚îÅ‚îÅ Á¨¨ ${G.round} Â§© ‚îÅ‚îÅ‚îÅ‚îÅ`);

  // AI speeches with delay
  const alive = G.players.filter(p => p.alive && !p.isHuman);
  let delay = 0;
  alive.forEach(p => {
    delay += 700 + Math.random() * 500;
    setTimeout(() => {
      const pool = p.role === 'wolf' ? WOLF_SAYS : GOOD_SAYS;
      addSpeech(p, rnd(pool));
    }, delay);
  });

  setTimeout(() => {
    const human = G.players[G.humanIdx];
    if (human.alive) {
      showVoteAction();
    } else {
      addSystem('‰Ω†Â∑≤Ê≠ª‰∫°ÔºåÂè™ËÉΩÊóÅËßÇÊú¨Â±Ä‚Ä¶');
      doAIVotes(null);
    }
  }, delay + 500);
}

function showVoteAction() {
  const human = G.players[G.humanIdx];
  G.selectedId = null;
  renderPlayers(p => p.id !== human.id);
  setAction({
    title: '‚öîÔ∏è ÁôΩÂ§©ÊäïÁ•®',
    desc: 'ËØ∑ÈÄâÊã©‰∏ÄÂêçÁé©ÂÆ∂ÊäïÁ•®È©±ÈÄêÔºåÊàñÂºÉÁ•®„ÄÇ',
    buttons: [
      { text: 'ÊäïÁ•®È©±ÈÄê', gold: true, fn: () => {
        if (G.selectedId === null) { flashDesc('ËØ∑ÂÖàÈÄâÊã©ÊäïÁ•®ÁõÆÊ†á'); return; }
        const tgt = G.players[G.selectedId];
        addSpeech(human, `ÊàëÊäïÁ•®È©±ÈÄê ${tgt.seat}Âè∑ ${tgt.name}ÔºÅ`);
        const humanVote = G.selectedId;
        G.selectedId = null;
        clearAction();
        doAIVotes(humanVote);
      }},
      { text: 'ÂºÉÁ•®', fn: () => {
        addSpeech(human, 'ÊàëÈÄâÊã©ÂºÉÁ•®„ÄÇ');
        G.selectedId = null;
        clearAction();
        doAIVotes(null);
      }},
    ]
  });
}

function doAIVotes(humanVote) {
  // Collect votes
  const voteMap = {};
  G.players.filter(p => p.alive).forEach(p => {
    let tgtId = null;
    if (p.isHuman) {
      tgtId = humanVote; // may be null if abstain
    } else if (p.role === 'wolf') {
      const good = G.players.filter(x => x.alive && x.role !== 'wolf');
      if (good.length) tgtId = rnd(good).id;
    } else {
      const others = G.players.filter(x => x.alive && x.id !== p.id);
      if (!others.length) return;
      const wolves = others.filter(x => x.role === 'wolf');
      tgtId = (wolves.length > 0 && Math.random() < 0.4) ? rnd(wolves).id : rnd(others).id;
    }
    if (tgtId !== null) voteMap[tgtId] = (voteMap[tgtId] || 0) + 1;
  });

  // Find winner
  let maxV = 0, maxId = null, tie = false;
  Object.entries(voteMap).forEach(([id, v]) => {
    const n = parseInt(id);
    if (v > maxV) { maxV = v; maxId = n; tie = false; }
    else if (v === maxV) { tie = true; }
  });

  // Show vote result
  if (tie || maxId === null) {
    addSystem('‚öñÔ∏è ÊäïÁ•®Âπ≥Â±ÄÔºÅ‰ªäÂ§©Ê≤°Êúâ‰∫∫Âá∫Â±Ä„ÄÇ');
    endDay();
    return;
  }

  const exiled = G.players[maxId];
  exiled.alive = false;
  renderPlayers(null);

  const rd = ROLES[exiled.role];
  addSystem(`üó≥Ô∏è ${exiled.name} Ë¢´ÊäïÁ•®Âá∫Â±ÄÔºÅË∫´‰ªΩÊè≠Á§∫Ôºö${rd.icon} ${rd.name}`);

  if (checkWin()) return;

  if (exiled.role === 'hunter' && G.witchPoison !== exiled.id) {
    handleHunter(exiled.id, () => endDay());
  } else {
    endDay();
  }
}

// ============================================================
// HUNTER
// ============================================================
function handleHunter(hunterId, onDone) {
  const hunter = G.players[hunterId];
  addSystem(`üî´ Áåé‰∫∫ ${hunter.name} Ê≠ª‰∫°ÔºåÂèØ‰ª•ÂºÄÊû™Â∏¶Ëµ∞‰∏ÄÂêçÁé©ÂÆ∂ÔºÅ`);

  if (hunter.isHuman) {
    G.selectedId = null;
    renderPlayers(p => p.id !== hunterId);
    setAction({
      title: 'üî´ Áåé‰∫∫ÂºÄÊû™',
      desc: '‰Ω†Ê≠ª‰∫°‰∫ÜÔºåÂèØ‰ª•ÂºÄÊû™Â∏¶Ëµ∞‰∏ÄÂêçÁé©ÂÆ∂ÔºåÊàñÈÄâÊã©‰∏çÂºÄÊû™„ÄÇ',
      buttons: [
        { text: 'ÂºÄÊû™', fn: () => {
          if (G.selectedId === null) { flashDesc('ËØ∑ÂÖàÈÄâÊã©ÁõÆÊ†á'); return; }
          const tgt = G.players[G.selectedId];
          tgt.alive = false;
          renderPlayers(null);
          addSystem(`üî´ Áåé‰∫∫ ${hunter.name} ÂºÄÊû™Â∏¶Ëµ∞‰∫Ü ${tgt.name}Ôºà${ROLES[tgt.role].name}Ôºâ`);
          G.selectedId = null;
          clearAction();
          if (checkWin()) return;
          onDone();
        }},
        { text: '‰∏çÂºÄÊû™', fn: () => {
          G.selectedId = null;
          clearAction();
          onDone();
        }},
      ]
    });
  } else {
    // AI hunter shoots random alive player
    const targets = G.players.filter(p => p.alive && p.id !== hunterId);
    if (targets.length) {
      const tgt = rnd(targets);
      tgt.alive = false;
      renderPlayers(null);
      addSystem(`üî´ Áåé‰∫∫ ${hunter.name} ÂºÄÊû™Â∏¶Ëµ∞‰∫Ü ${tgt.name}Ôºà${ROLES[tgt.role].name}Ôºâ`);
      if (checkWin()) return;
    }
    onDone();
  }
}

// ============================================================
// END DAY
// ============================================================
function endDay() {
  G.round++;
  beginNight();
}

// ============================================================
// WIN CHECK
// ============================================================
function checkWin() {
  const wolves = G.players.filter(p => p.alive && p.role === 'wolf').length;
  const good   = G.players.filter(p => p.alive && p.role !== 'wolf').length;
  if (wolves === 0) { showWin('village'); return true; }
  if (wolves >= good) { showWin('wolf'); return true; }
  return false;
}

function showWin(winner) {
  const human = G.players[G.humanIdx];
  const humanWon = (winner === 'wolf') === (human.role === 'wolf');

  const ws = document.getElementById('win-screen');
  ws.className = (winner === 'wolf' ? 'wolf-win' : 'village-win') + ' open';

  document.getElementById('win-icon').textContent  = winner === 'wolf' ? 'üê∫' : 'üåÖ';
  document.getElementById('win-title').textContent = winner === 'wolf' ? 'Áãº‰∫∫Ëé∑ËÉúÔºÅ' : 'ÊùëÊ∞ëËé∑ËÉúÔºÅ';
  document.getElementById('win-sub').textContent   = humanWon ? 'üéâ ÊÅ≠Âñú‰Ω†ÔºÅËøôÂ±Ä‰Ω†Ëµ¢‰∫ÜÔºÅ' : 'üò¢ ÂæàÈÅóÊÜæÔºåËøôÂ±Ä‰Ω†Ë¥•‰∫Ü‚Ä¶';

  const list = document.getElementById('reveal-list');
  list.innerHTML = '';
  G.players.forEach(p => {
    const rd = ROLES[p.role];
    const chip = document.createElement('div');
    chip.className = 'reveal-chip';
    chip.textContent = `${p.alive ? '‚úÖ' : '‚ùå'} ${p.name} ¬∑ ${rd.name}${rd.icon}`;
    list.appendChild(chip);
  });
}

// ============================================================
// BIND EVENTS
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
  // Title screen
  document.getElementById('s-title').classList.add('active');

  document.getElementById('diff-easy').addEventListener('click', () => {
    difficulty = 'easy';
    document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('diff-easy').classList.add('active');
  });
  document.getElementById('diff-normal').addEventListener('click', () => {
    difficulty = 'normal';
    document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('diff-normal').classList.add('active');
  });
  document.getElementById('diff-hard').addEventListener('click', () => {
    difficulty = 'hard';
    document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('diff-hard').classList.add('active');
  });

  document.getElementById('btn-start').addEventListener('click', () => {
    document.getElementById('win-screen').className = '';
    initGame();
  });

  document.getElementById('btn-replay').addEventListener('click', () => {
    document.getElementById('win-screen').className = '';
    document.getElementById('speech-log').innerHTML = '';
    showScreen('s-title');
  });
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç‹¼äººæ€ Â· å•æœºç‰ˆ</title>
<link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+QingKe+HuangYou&family=Noto+Serif+SC:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #1a0f00;
  --ink2: #2d1a05;
  --parchment: #f4e9d0;
  --parchment2: #e8d8b0;
  --parchment3: #d4c090;
  --red: #8b1a1a;
  --red2: #c0392b;
  --gold: #8b6914;
  --gold2: #c8921a;
  --blue-ink: #1a3a5c;
  --green-ink: #1a4a2a;
  --fade: rgba(26,15,0,0.08);
  --shadow: rgba(26,15,0,0.25);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Noto Serif SC', serif;
  background: var(--ink);
  min-height: 100vh;
  color: var(--ink);
  overflow-x: hidden;
}

/* Parchment texture overlay */
body::before {
  content:'';
  position:fixed; inset:0;
  background: repeating-linear-gradient(
    0deg, transparent, transparent 2px,
    rgba(26,15,0,0.015) 2px, rgba(26,15,0,0.015) 4px
  );
  pointer-events:none; z-index:0;
}

/* ===== SCREENS ===== */
.screen { display:none; }
.screen.active { display:block; }
#s-title.active { display:flex; flex-direction:column; align-items:center; justify-content:center; }
#s-game.active  { display:grid; }

/* ===== TITLE ===== */
#s-title {
  min-height:100vh;
  background: radial-gradient(ellipse at 50% 40%, #2d1a05 0%, #0d0800 100%);
  text-align:center; padding:40px 20px;
}

.title-scroll {
  background: linear-gradient(180deg, #e8d5a0 0%, #f0e4b8 30%, #f0e4b8 70%, #e8d5a0 100%);
  border: 3px solid var(--gold);
  padding: 50px 60px;
  max-width: 480px;
  width: 100%;
  position: relative;
  box-shadow: 0 0 60px rgba(139,105,20,0.3), inset 0 0 40px rgba(200,146,26,0.1);
}

.title-scroll::before, .title-scroll::after {
  content:'';
  position:absolute; left:-12px; right:-12px; height:30px;
  background: linear-gradient(180deg, #8b6914, #c8921a, #8b6914);
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
.title-scroll::before { top:-14px; }
.title-scroll::after { bottom:-14px; }

.title-eyebrow {
  font-family: 'ZCOOL QingKe HuangYou', cursive;
  font-size:12px; letter-spacing:0.5em; color:var(--gold); margin-bottom:16px;
}

h1.main-title {
  font-family: 'Ma Shan Zheng', cursive;
  font-size: clamp(52px, 15vw, 88px);
  color: var(--red);
  text-shadow: 2px 2px 0 rgba(139,26,26,0.3), 4px 4px 8px rgba(0,0,0,0.2);
  letter-spacing: 0.15em;
  line-height: 1;
  margin-bottom: 8px;
}

.title-sub {
  font-size:13px; color:var(--gold); letter-spacing:0.3em; margin-bottom:32px;
  border-top: 1px solid var(--gold); border-bottom: 1px solid var(--gold);
  padding: 8px 0;
}

.title-seal {
  font-size:48px; margin-bottom:20px;
  animation: sealBreath 3s ease-in-out infinite alternate;
}
@keyframes sealBreath {
  from { transform:scale(0.96) rotate(-2deg); filter:drop-shadow(0 0 8px rgba(139,26,26,0.4)); }
  to   { transform:scale(1.04) rotate(2deg);  filter:drop-shadow(0 0 20px rgba(139,26,26,0.7)); }
}

.title-flavor {
  font-size:13px; color:var(--ink2); line-height:1.8; margin-bottom:28px;
  font-style:italic;
}

/* Difficulty picker */
.diff-row {
  display:flex; gap:8px; justify-content:center; margin-bottom:20px;
}
.diff-btn {
  background:none; border:1px solid var(--gold);
  font-family:'Noto Serif SC',serif; font-size:12px;
  padding:6px 14px; cursor:pointer; color:var(--ink2);
  transition:all 0.2s; letter-spacing:0.1em;
}
.diff-btn.active, .diff-btn:hover { background:var(--gold); color:var(--parchment); }

.start-btn {
  background: var(--red); border: 2px solid var(--red2);
  color: var(--parchment); font-family:'Ma Shan Zheng',cursive;
  font-size:22px; padding:14px 48px; cursor:pointer; letter-spacing:0.3em;
  transition:all 0.2s; clip-path:polygon(10px 0,100% 0,calc(100% - 10px) 100%,0 100%);
  box-shadow:0 4px 20px rgba(139,26,26,0.4);
}
.start-btn:hover { background:var(--red2); transform:translateY(-2px); box-shadow:0 8px 30px rgba(192,57,43,0.5); }
.start-btn:active { transform:translateY(0); }

/* ===== GAME LAYOUT ===== */
#s-game {
  min-height:100vh;
  background: linear-gradient(135deg, #1a0e04 0%, #0d0800 50%, #1a0a04 100%);
  grid-template-rows: auto 1fr auto;
  grid-template-columns: 1fr;
  max-width:700px; margin:0 auto;
  padding-bottom:20px;
}

/* Header */
.game-hdr {
  background: linear-gradient(90deg, #2d1a05, #1a0f00, #2d1a05);
  border-bottom: 2px solid var(--gold);
  padding:10px 20px;
  display:flex; align-items:center; justify-content:space-between;
  position:sticky; top:0; z-index:50;
}

.phase-indicator {
  font-family:'Ma Shan Zheng',cursive;
  font-size:22px; letter-spacing:0.3em;
}
.phase-indicator.night { color:#a0c8ff; text-shadow:0 0 15px rgba(160,200,255,0.6); }
.phase-indicator.day   { color:#ffd080; text-shadow:0 0 15px rgba(255,208,128,0.6); }

.round-badge {
  background: rgba(139,105,20,0.2); border:1px solid var(--gold);
  padding:4px 12px; font-size:12px; color:var(--gold); letter-spacing:0.15em;
}

/* Main area */
.game-main {
  padding:16px;
  display:flex; flex-direction:column; gap:14px;
}

/* Players table - round arrangement */
.village-table {
  background: linear-gradient(135deg, #e8d5a0, #f0e4b8, #e0cc90);
  border: 3px solid var(--gold);
  border-radius:4px;
  padding:20px 16px;
  position:relative;
  box-shadow: inset 0 0 30px rgba(139,105,20,0.15), 0 4px 20px rgba(0,0,0,0.5);
}

.village-table::before {
  content:'ğŸ˜ï¸ æ‘åº„è®®äº‹å°';
  position:absolute; top:-14px; left:50%; transform:translateX(-50%);
  background:var(--parchment2); border:1px solid var(--gold);
  padding:2px 14px; font-size:11px; color:var(--gold); letter-spacing:0.2em;
  white-space:nowrap;
}

.players-ring {
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(90px,1fr));
  gap:10px;
}

.player-card {
  background: linear-gradient(180deg, #fdf5e0, #f5e8c0);
  border: 2px solid var(--parchment3);
  padding:10px 6px 8px;
  text-align:center; cursor:default;
  position:relative; transition:all 0.2s;
  box-shadow: 2px 2px 6px rgba(0,0,0,0.15);
}

.player-card.is-you {
  border-color: var(--gold2);
  box-shadow: 0 0 0 2px rgba(200,146,26,0.3), 2px 2px 6px rgba(0,0,0,0.15);
}

.player-card.selectable {
  cursor:pointer;
  border-color: var(--red);
}
.player-card.selectable:hover {
  transform:translateY(-3px) scale(1.03);
  box-shadow: 0 6px 16px rgba(139,26,26,0.3);
  border-color:var(--red2);
  background: linear-gradient(180deg, #fff0e0, #ffe0c0);
}

.player-card.selected {
  border-color:var(--red2); background:linear-gradient(180deg,#ffe8e0,#ffd0c0);
  box-shadow:0 0 0 3px rgba(192,57,43,0.4), 2px 2px 6px rgba(0,0,0,0.2);
  transform:translateY(-3px);
}

.player-card.dead {
  opacity:0.4; cursor:default; filter:grayscale(0.5);
}
.player-card.dead::after {
  content:'â€ '; position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  font-size:36px; color:var(--red); opacity:0.6;
}

.pc-seat { font-size:9px; color:var(--gold); margin-bottom:3px; letter-spacing:0.1em; }
.pc-avatar { font-size:26px; line-height:1; margin-bottom:4px; }
.pc-name { font-size:11px; color:var(--ink); font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.pc-role-tag {
  font-size:9px; margin-top:3px;
  padding:1px 6px; display:inline-block;
}
.pc-role-tag.wolf { background:rgba(139,26,26,0.15); color:var(--red); border:1px solid rgba(139,26,26,0.3); }
.pc-role-tag.good { background:rgba(26,74,42,0.15); color:var(--green-ink); border:1px solid rgba(26,74,42,0.3); }

.you-badge {
  position:absolute; top:-8px; right:4px;
  background:var(--gold); color:var(--parchment); font-size:8px;
  padding:1px 5px; letter-spacing:0.1em;
}

/* Speech bubbles log */
.speech-log {
  background: linear-gradient(180deg, #1a0f00, #0d0800);
  border: 1px solid rgba(139,105,20,0.3);
  padding:14px;
  max-height:280px; overflow-y:auto;
  display:flex; flex-direction:column; gap:10px;
}

.speech-log::-webkit-scrollbar { width:3px; }
.speech-log::-webkit-scrollbar-thumb { background:var(--gold); }

.speech-item {
  display:flex; gap:10px; align-items:flex-start;
  animation: speechIn 0.4s ease-out;
}
@keyframes speechIn {
  from { opacity:0; transform:translateX(-12px); }
  to   { opacity:1; transform:translateX(0); }
}

.speech-item.right { flex-direction:row-reverse; }
.speech-item.system { justify-content:center; flex-direction:column; align-items:center; }

.speech-avatar-sm { font-size:22px; flex-shrink:0; }

.bubble {
  max-width:75%; padding:8px 12px;
  position:relative; line-height:1.6;
  font-size:13px;
}

.speech-item:not(.right):not(.system) .bubble {
  background: linear-gradient(135deg, #f0e4b8, #e8d8a0);
  color:var(--ink); border:1px solid var(--parchment3);
  border-radius:0 8px 8px 8px;
}
.speech-item.right .bubble {
  background: linear-gradient(135deg, #3a1a08, #2a1205);
  color:#e8d5b0; border:1px solid rgba(200,146,26,0.3);
  border-radius:8px 0 8px 8px;
}
.speech-item.system .bubble {
  background:rgba(139,26,26,0.15); border:1px solid rgba(139,26,26,0.3);
  color:#e0a080; font-size:12px; letter-spacing:0.05em; text-align:center;
  border-radius:4px; width:100%;
}

.bubble-name {
  font-size:10px; margin-bottom:3px; opacity:0.7; font-weight:700;
}
.speech-item.right .bubble-name { text-align:right; }

.speech-item.wolf-talk .bubble { border-color:rgba(139,26,26,0.5); background:linear-gradient(135deg,#3a0808,#200505); color:#ffb0a0; }

/* Action panel */
.action-panel {
  background: linear-gradient(180deg, #e8d5a0, #dcc888);
  border: 2px solid var(--gold);
  padding:16px;
}

.action-panel-title {
  font-family:'ZCOOL QingKe HuangYou',cursive;
  font-size:14px; color:var(--red); letter-spacing:0.3em;
  margin-bottom:10px; border-bottom:1px solid var(--gold2); padding-bottom:6px;
}

.action-desc {
  font-size:13px; color:var(--ink2); line-height:1.8; margin-bottom:12px;
}

.action-btns-row {
  display:flex; gap:8px; flex-wrap:wrap;
}

.ink-btn {
  background: var(--ink); border:1px solid var(--gold);
  color:var(--parchment); font-family:'Noto Serif SC',serif;
  font-size:13px; padding:8px 20px; cursor:pointer;
  letter-spacing:0.1em; transition:all 0.2s;
  clip-path:polygon(6px 0,100% 0,calc(100% - 6px) 100%,0 100%);
}
.ink-btn:hover { background:var(--red); border-color:var(--red2); transform:translateY(-1px); }
.ink-btn:active { transform:translateY(0); }
.ink-btn.gold-btn { background:var(--gold); border-color:var(--gold2); color:var(--ink); }
.ink-btn.gold-btn:hover { background:var(--gold2); }

/* Role card overlay */
.role-reveal-overlay {
  position:fixed; inset:0; z-index:200;
  background:rgba(5,2,0,0.92);
  display:flex; align-items:center; justify-content:center;
  backdrop-filter:blur(6px);
}

.role-card-big {
  background: linear-gradient(160deg, #f5e8c0, #ecdba0, #f0e4b8);
  border: 4px solid var(--gold);
  padding:40px 50px; max-width:360px; width:90%;
  text-align:center; position:relative;
  box-shadow: 0 0 60px rgba(139,105,20,0.5), inset 0 0 40px rgba(200,146,26,0.1);
  animation:cardIn 0.5s cubic-bezier(0.175,0.885,0.32,1.275);
}
@keyframes cardIn {
  from { opacity:0; transform:scale(0.6) rotate(-5deg); }
  to   { opacity:1; transform:scale(1) rotate(0); }
}

.role-card-big::before, .role-card-big::after {
  content:''; position:absolute; left:-8px; right:-8px; height:24px;
  background:linear-gradient(90deg,var(--gold),var(--gold2),var(--gold));
}
.role-card-big::before { top:-10px; }
.role-card-big::after { bottom:-10px; }

.rc-team { font-size:11px; letter-spacing:0.4em; margin-bottom:16px; }
.rc-team.wolf { color:var(--red); }
.rc-team.village { color:var(--green-ink); }

.rc-icon { font-size:72px; margin-bottom:12px; animation:iconPop 0.6s 0.3s ease-out both; }
@keyframes iconPop {
  from { transform:scale(0); }
  to   { transform:scale(1); }
}

.rc-name {
  font-family:'Ma Shan Zheng',cursive; font-size:42px;
  letter-spacing:0.2em; margin-bottom:10px;
}
.rc-name.wolf { color:var(--red); }
.rc-name.village { color:var(--blue-ink); }
.rc-name.witch-c { color:#5a1a6a; }
.rc-name.seer-c { color:var(--blue-ink); }
.rc-name.guard-c { color:var(--green-ink); }

.rc-divider {
  border: none; border-top:1px solid var(--gold2); margin:12px 0;
}

.rc-desc {
  font-size:13px; color:var(--ink2); line-height:1.8; margin-bottom:24px;
}

.rc-skill {
  background:rgba(26,15,0,0.08); border:1px solid rgba(139,105,20,0.3);
  padding:10px 14px; font-size:12px; color:var(--ink2); margin-bottom:20px;
  text-align:left; line-height:1.6;
}

/* Night overlay */
.night-overlay {
  position:fixed; inset:0; z-index:100;
  background:rgba(0,5,20,0.97);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  text-align:center; padding:30px;
}

.night-title {
  font-family:'Ma Shan Zheng',cursive; font-size:52px;
  color:#8080ff; text-shadow:0 0 30px rgba(128,128,255,0.8);
  margin-bottom:16px; letter-spacing:0.3em;
  animation:nightGlow 2s ease-in-out infinite alternate;
}
@keyframes nightGlow {
  from { text-shadow:0 0 20px rgba(128,128,255,0.5); }
  to   { text-shadow:0 0 50px rgba(128,128,255,1); }
}

.night-msg { color:#8090c0; font-size:15px; line-height:1.8; margin-bottom:24px; }

.night-secret-box {
  background:rgba(10,15,40,0.9); border:1px solid rgba(80,80,200,0.3);
  padding:20px 30px; margin:16px 0; min-width:280px;
}
.night-secret-label { font-size:11px; color:#6070a0; letter-spacing:0.3em; margin-bottom:10px; }
.night-secret-value { font-size:18px; color:#c0c8ff; font-family:'Ma Shan Zheng',cursive; letter-spacing:0.15em; }

/* Vote tally */
.vote-tally {
  display:flex; flex-direction:column; gap:6px; margin:10px 0;
}
.vote-bar-row {
  display:flex; align-items:center; gap:8px; font-size:12px; color:var(--ink2);
}
.vote-bar {
  height:12px; background:var(--red); transition:width 0.5s;
  min-width:4px;
}
.vote-count { font-weight:700; color:var(--red); min-width:20px; }

/* Win screen */
.win-screen {
  position:fixed; inset:0; z-index:300;
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  text-align:center; padding:30px;
}
.win-screen.wolf-win { background:radial-gradient(ellipse,#3a0808,#0d0200); }
.win-screen.village-win { background:radial-gradient(ellipse,#1a3020,#050d08); }

.win-icon { font-size:80px; animation:winPulse 1.5s ease-in-out infinite alternate; margin-bottom:16px; }
@keyframes winPulse {
  from { transform:scale(0.9); filter:drop-shadow(0 0 10px gold); }
  to   { transform:scale(1.1); filter:drop-shadow(0 0 40px gold); }
}

.win-title {
  font-family:'Ma Shan Zheng',cursive; font-size:56px; letter-spacing:0.3em; margin-bottom:10px;
}
.wolf-win .win-title { color:#ff6060; text-shadow:0 0 30px rgba(255,96,96,0.7); }
.village-win .win-title { color:#80e0a0; text-shadow:0 0 30px rgba(128,224,160,0.7); }

.win-sub { color:#aaa; font-size:14px; margin-bottom:24px; }

.reveal-list {
  display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-bottom:28px;
  max-width:400px;
}
.reveal-chip {
  background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2);
  padding:6px 14px; font-size:12px; color:#ddd;
}

/* Typing indicator */
.typing {
  display:flex; gap:4px; align-items:center; padding:4px 0;
}
.typing span {
  width:6px; height:6px; background:var(--gold); border-radius:50%;
  animation:typingBounce 1s ease-in-out infinite;
}
.typing span:nth-child(2) { animation-delay:0.15s; }
.typing span:nth-child(3) { animation-delay:0.3s; }
@keyframes typingBounce {
  0%,60%,100% { transform:translateY(0); opacity:0.5; }
  30% { transform:translateY(-6px); opacity:1; }
}

/* Skill resources display */
.skill-res {
  display:flex; gap:8px; font-size:12px; color:var(--gold); margin-bottom:8px;
}
.skill-pip { padding:2px 8px; border:1px solid var(--gold2); background:rgba(139,105,20,0.15); }
.skill-pip.used { opacity:0.3; text-decoration:line-through; }

/* Fade overlay for transition */
.fade-overlay {
  position:fixed; inset:0; z-index:150; background:#000;
  pointer-events:none; opacity:0; transition:opacity 0.4s;
}
.fade-overlay.show { opacity:1; }
</style>
</head>
<body>
<div class="fade-overlay" id="fade-overlay"></div>

<!-- TITLE -->
<div id="s-title" class="screen active">
  <div class="title-scroll">
    <div class="title-eyebrow">Â· å•äººæŒ‘æˆ˜ Â· äººæœºå¯¹æˆ˜ Â·</div>
    <div class="title-seal">ğŸº</div>
    <h1 class="main-title">ç‹¼äººæ€</h1>
    <div class="title-sub">å¤œè‰²ä¸­çš„çœŸç›¸</div>
    <div class="title-flavor">é»‘å¤œé™ä¸´ï¼Œç‹¼äººé†’æ¥ã€‚<br>ä½ èƒ½æ‰¾å‡ºæ½œä¼åœ¨æ‘åº„ä¸­çš„æ¶é­”å—ï¼Ÿ<br>è¿˜æ˜¯è¯´ï¼Œä½ å°±æ˜¯é‚£å¤´æŠ«ç€ç¾Šçš®çš„ç‹¼â€¦â€¦</div>
    <div style="font-size:12px;color:var(--gold);margin-bottom:12px;letter-spacing:0.2em;">é€‰æ‹©éš¾åº¦</div>
    <div class="diff-row">
      <button class="diff-btn active" id="diff-easy">ç®€å•<br><span style="font-size:10px">6äººå±€</span></button>
      <button class="diff-btn" id="diff-normal">æ™®é€š<br><span style="font-size:10px">8äººå±€</span></button>
      <button class="diff-btn" id="diff-hard">å›°éš¾<br><span style="font-size:10px">10äººå±€</span></button>
    </div>
    <br>
    <button class="start-btn" id="btn-start">å…¥æ‘</button>
  </div>
</div>

<!-- GAME -->
<div id="s-game" class="screen">
  <div class="game-hdr">
    <div class="phase-indicator night" id="phase-indicator">ğŸŒ‘ é»‘å¤œ</div>
    <div class="round-badge" id="round-badge">ç¬¬ 1 å¤œ</div>
  </div>

  <div class="game-main">
    <!-- Players -->
    <div class="village-table">
      <div class="players-ring" id="players-ring"></div>
    </div>

    <!-- Speech log -->
    <div class="speech-log" id="speech-log"></div>

    <!-- Action panel -->
    <div class="action-panel" id="action-panel">
      <div class="action-panel-title" id="action-title">â—ˆ ç­‰å¾…ä¸­</div>
      <div class="skill-res" id="skill-res" style="display:none"></div>
      <div class="action-desc" id="action-desc">æ¸¸æˆå‡†å¤‡ä¸­...</div>
      <div class="action-btns-row" id="action-btns"></div>
    </div>
  </div>
</div>

<!-- Role reveal overlay -->
<div id="role-overlay" class="role-reveal-overlay" style="display:none">
  <div class="role-card-big" id="role-card">
    <div class="rc-team" id="rc-team">Â·å¥½äººé˜µè¥Â·</div>
    <div class="rc-icon" id="rc-icon">ğŸ§‘â€ğŸŒ¾</div>
    <div class="rc-name" id="rc-name">æ‘æ°‘</div>
    <hr class="rc-divider">
    <div class="rc-desc" id="rc-desc">æ™®é€šæ‘æ°‘</div>
    <div class="rc-skill" id="rc-skill">æŠ€èƒ½è¯´æ˜</div>
    <button class="ink-btn" id="btn-close-role">æˆ‘å·²çŸ¥æ™“ï¼Œè¿›å…¥æ¸¸æˆ</button>
  </div>
</div>

<!-- Night action overlay -->
<div id="night-overlay" class="night-overlay" style="display:none">
  <div class="night-title" id="night-overlay-title">ğŸŒ‘ é»‘å¤œé™ä¸´</div>
  <div class="night-msg" id="night-overlay-msg">æ‰€æœ‰äººè¯·é—­ä¸Šçœ¼ç›...</div>
  <div class="night-secret-box" id="night-secret-box" style="display:none">
    <div class="night-secret-label" id="night-secret-label">æŸ¥éªŒç»“æœ</div>
    <div class="night-secret-value" id="night-secret-value">---</div>
  </div>
  <button class="ink-btn" id="night-overlay-btn">ç¡®è®¤</button>
</div>

<!-- Win screen -->
<div id="win-screen" class="win-screen" style="display:none">
  <div class="win-icon" id="win-icon">ğŸ†</div>
  <div class="win-title" id="win-title">æ¸¸æˆç»“æŸ</div>
  <div class="win-sub" id="win-sub">---</div>
  <div class="reveal-list" id="reveal-list"></div>
  <button class="start-btn" id="btn-replay">å†æ¥ä¸€å±€</button>
</div>

<script>
// ===== CONSTANTS =====
const ROLE_DATA = {
  wolf:     { name:'ç‹¼äºº',  icon:'ğŸº', team:'wolf',    color:'wolf-c',   skill:'æ¯å¤œä¸ç‹¼é˜Ÿå•†è®®åå‡»æ€ä¸€åç©å®¶ã€‚ç™½å¤©ä¼ªè£…èº«ä»½ï¼Œå‚ä¸æŠ•ç¥¨é©±é€å¥½äººã€‚' },
  seer:     { name:'é¢„è¨€å®¶',icon:'ğŸ”®', team:'village', color:'seer-c',   skill:'æ¯å¤œå¯æŸ¥éªŒä¸€åç©å®¶çš„çœŸå®èº«ä»½ï¼ˆç‹¼äºº/å¥½äººï¼‰ã€‚åˆ©ç”¨ä¿¡æ¯å¼•å¯¼æ‘æ°‘ã€‚' },
  witch:    { name:'å¥³å·«',  icon:'âš—ï¸', team:'village', color:'witch-c',  skill:'æ‹¥æœ‰è§£è¯Ã—1ï¼ˆæ•‘ç‹¼æ€ç›®æ ‡ï¼‰å’Œæ¯’è¯Ã—1ï¼ˆå¤œæ™šæ¯’æ€ä»»æ„ç©å®¶ï¼‰ã€‚' },
  guard:    { name:'å®ˆå«',  icon:'ğŸ›¡ï¸', team:'village', color:'guard-c',  skill:'æ¯å¤œå¯å®ˆæŠ¤ä¸€åç©å®¶å…å—ç‹¼æ€ã€‚ä¸å¯è¿ç»­å®ˆæŠ¤åŒä¸€äººã€‚' },
  hunter:   { name:'çŒäºº',  icon:'ğŸ”«', team:'village', color:'guard-c',  skill:'æ­»äº¡æ—¶å¯ç«‹å³å¼€æªå¸¦èµ°ä¸€åç©å®¶ï¼ˆè¢«æ¯’æ­»æ—¶æ— æ³•å¼€æªï¼‰ã€‚' },
  villager: { name:'æ‘æ°‘',  icon:'ğŸ§‘â€ğŸŒ¾',team:'village', color:'village-c',skill:'å‡­å€Ÿæ™ºæ…§å’Œå£æ‰ï¼Œåœ¨ç™½å¤©è®¨è®ºä¸­æ‰¾å‡ºç‹¼äººå¹¶æŠ•ç¥¨é©±é€ã€‚' },
};

const WOLF_SPEECHES_DAY = [
  ['æˆ‘æ˜¨æ™šç¡å¾—å¾ˆå¥½ï¼Œä»€ä¹ˆéƒ½ä¸çŸ¥é“â€¦', 'å¤§å®¶å†·é™åˆ†æï¼Œä¸è¦ä¹±æŠ•ã€‚', 'æˆ‘ç›¸ä¿¡é¢„è¨€å®¶ä¼šç»™æˆ‘ä»¬æŒ‡å¼•ã€‚', 'è¿™å±€æ„Ÿè§‰æœ‰äº›äººå¤ªå¯ç–‘äº†â€¦'],
  ['æˆ‘æ˜¨æ™šæ²¡æœ‰ä»»ä½•ç‰¹æ®Šè¡ŒåŠ¨ã€‚', 'å¤§å®¶æ³¨æ„è§‚å¯Ÿå‘è¨€é€»è¾‘ã€‚', 'æˆ‘è§‰å¾—æˆ‘ä»¬åº”è¯¥å¬é¢„è¨€å®¶çš„ã€‚', 'è°çš„å‘è¨€æœ€å¥‡æ€ªï¼Œå°±å…ˆæŠ•è°ã€‚'],
  ['æˆ‘æ˜¯å¥½äººï¼Œä¸éœ€è¦è§£é‡Šå¤ªå¤šã€‚', 'ç°åœ¨ä¹±æŠ•æ²¡æ„ä¹‰ï¼Œè¦æœ‰ä¾æ®ã€‚', 'æˆ‘è§‰å¾—{0}å·å‘è¨€æœ‰é—®é¢˜ã€‚', 'å¤§å®¶åˆ«è¢«ç‹¼äººå¸¦èŠ‚å¥äº†ã€‚'],
];
const GOOD_SPEECHES_DAY = [
  ['æˆ‘æ˜¨æ™šå¹³å®‰ï¼Œæ²¡å‘ç°ä»€ä¹ˆå¼‚å¸¸ã€‚', 'å¤§å®¶æ³¨æ„è§‚å¯Ÿç‹¼äººçš„é€»è¾‘æ¼æ´ã€‚', 'æŠ•ç¥¨è¦æ…é‡ï¼Œé”™æ€å¥½äººå¯¹æˆ‘ä»¬ä¸åˆ©ã€‚', 'æˆ‘æ”¯æŒç†æ€§è®¨è®ºã€‚'],
  ['æ˜¨æ™šæˆ‘åªæ˜¯æ™®é€šæ‘æ°‘åœ¨ç¡è§‰ã€‚', 'æˆ‘ä»¬éœ€è¦æ‰¾å‡ºå†…é¬¼æ‰èƒ½è·èƒœã€‚', 'æˆ‘è®¤ä¸ºè®¤çœŸåˆ†ææ¯”ä¹±çŒœé‡è¦ã€‚', 'æœ‰ä»»ä½•çº¿ç´¢è¯·è¯´å‡ºæ¥ã€‚'],
  ['æˆ‘æ²¡æœ‰ç‰¹æ®Šè§’è‰²ï¼Œæ˜¯æ™®é€šæ‘æ°‘ã€‚', 'å¤§å®¶äº’ç›¸åˆ†æä¸€ä¸‹ä»Šå¤©çš„å±€åŠ¿ã€‚', 'æ„Ÿè§‰{0}å·çš„å‘è¨€æœ‰äº›å¥‡æ€ªï¼Ÿ', 'æˆ‘ä»¬è¦å›¢ç»“ä¸€è‡´å¯¹ä»˜ç‹¼äººã€‚'],
];
const NAMES = ['é˜¿æ˜','æ™“äº‘','å¤§å£®','ç§€è‹±','é˜¿è™','å†¬æ¢…','è€é“','å°èŠ±','é˜¿é£','å»ºå›½','ç¿ è²','å¤§åˆš'];
const AVATARS = ['ğŸ‘¨','ğŸ‘©','ğŸ‘´','ğŸ‘µ','ğŸ§‘','ğŸ‘±','ğŸ§”','ğŸ‘²','ğŸ§•','ğŸ‘¨â€ğŸ¦±','ğŸ‘©â€ğŸ¦±','ğŸ§’'];

// ===== STATE =====
let G = {};
let difficulty = 'easy';

function setDiff(d) {
  difficulty = d;
  document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('diff-' + d).classList.add('active');
}

function buildConfig(diff) {
  switch(diff) {
    case 'easy':   return { total:6,  wolves:2, seer:1, witch:1, guard:0, hunter:0 };
    case 'normal': return { total:8,  wolves:2, seer:1, witch:1, guard:1, hunter:0 };
    case 'hard':   return { total:10, wolves:3, seer:1, witch:1, guard:1, hunter:1 };
  }
}

function initGame() {
  const cfg = buildConfig(difficulty);
  const total = cfg.total;

  // Build roles
  let roles = [];
  for (let i=0;i<cfg.wolves;i++) roles.push('wolf');
  roles.push('seer'); roles.push('witch');
  if (cfg.guard) roles.push('guard');
  if (cfg.hunter) roles.push('hunter');
  while (roles.length < total) roles.push('villager');
  shuffle(roles);

  // Player index for human (random 0..total-1)
  const humanIdx = Math.floor(Math.random() * total);

  G = {
    players: [],
    humanIdx,
    round: 1,
    phase: 'night',
    wolfKill: null,
    witchSave: false,
    witchPoison: null,
    witchUsedSave: false,
    witchUsedPoison: false,
    guardProtect: null,
    guardLastProtect: null,
    seerResult: null,
    nightDeaths: [],
    log: [],
    selectedTarget: null,
    hunterPending: null,
    cfg,
    nightPhase: 0, // which night step
    witchPoisoned: false,
  };

  const usedNames = shuffle([...NAMES]).slice(0, total);
  const usedAvatars = shuffle([...AVATARS]).slice(0, total);

  for (let i=0;i<total;i++) {
    G.players.push({
      id: i, seat: i+1,
      name: i===humanIdx ? 'ä½ ' : usedNames[i],
      avatar: usedAvatars[i],
      role: roles[i],
      alive: true,
      isHuman: i===humanIdx,
    });
  }

  fadeTransition(() => {
    showScreen('s-game');
    renderPlayers();
    showRoleReveal();
  });
}

function showRoleReveal() {
  const p = G.players[G.humanIdx];
  const rd = ROLE_DATA[p.role];
  document.getElementById('rc-team').textContent = rd.team === 'wolf' ? 'Â· ç‹¼äººé˜µè¥ Â·' : 'Â· å¥½äººé˜µè¥ Â·';
  document.getElementById('rc-team').className = 'rc-team ' + rd.team;
  document.getElementById('rc-icon').textContent = rd.icon;
  document.getElementById('rc-name').textContent = rd.name;
  document.getElementById('rc-name').className = 'rc-name ' + rd.color;
  document.getElementById('rc-desc').textContent = rd.team === 'wolf'
    ? `ä½ æ˜¯ç‹¼äººï¼æ½œä¼åœ¨æ‘åº„ä¸­ï¼Œæ¶ˆç­æ‰€æœ‰å¥½äººã€‚`
    : `ä½ æ˜¯${rd.name}ï¼Œè¿ç”¨ä½ çš„åŠ›é‡å¸®åŠ©æ‘åº„æ‰¾å‡ºç‹¼äººï¼`;
  document.getElementById('rc-skill').innerHTML = `<strong>âš¡ æŠ€èƒ½ï¼š</strong>${rd.skill}`;
  document.getElementById('role-overlay').style.display = 'flex';
}

function closeRoleReveal() {
  document.getElementById('role-overlay').style.display = 'none';
  beginNight();
}

// ===== NIGHT PHASE =====
function beginNight() {
  G.phase = 'night';
  G.wolfKill = null;
  G.witchSave = false;
  G.witchPoison = null;
  G.guardProtect = null;
  G.seerResult = null;
  G.nightDeaths = [];
  G.selectedTarget = null;
  G.nightPhase = 0;
  G.witchPoisoned = false;
  updateHeader();
  runNightPhase();
}

function runNightPhase() {
  // Steps: 0=wolves act, 1=seer acts, 2=witch acts, 3=guard acts, 4=resolve
  const p = G.players[G.humanIdx];

  // Collect night steps
  const steps = [];
  steps.push('wolf');
  if (G.players.some(x=>x.alive&&x.role==='seer')) steps.push('seer');
  if (G.players.some(x=>x.alive&&x.role==='witch')) steps.push('witch');
  if (G.players.some(x=>x.alive&&x.role==='guard')) steps.push('guard');
  steps.push('resolve');

  if (G.nightPhase >= steps.length) { resolveNight(); return; }
  const step = steps[G.nightPhase];

  if (step === 'wolf') {
    if (p.alive && p.role === 'wolf') {
      // Human is wolf - show night overlay, let them pick
      showNightOverlay('ğŸº ç‹¼äººé†’æ¥', `ä½ æ˜¯ç‹¼äººã€‚é€‰æ‹©ä¸€åç©å®¶å‡»æ€ã€‚\nï¼ˆä½ çš„ç‹¼é˜Ÿå‹çŸ¥é“å½¼æ­¤èº«ä»½ï¼‰`, false, () => {
        document.getElementById('night-overlay').style.display = 'none';
        renderPlayers(true, [p.id, ...G.players.filter(x=>x.alive&&x.role==='wolf'&&x.id!==G.humanIdx).map(x=>x.id)]);
        setAction('ğŸº ç‹¼äººå‡»æ€', 'é€‰æ‹©ä»Šå¤œè¦å‡»æ€çš„ç›®æ ‡ï¼ˆä¸èƒ½é€‰è‡ªå·±æˆ–ç‹¼é˜Ÿå‹ï¼‰', [
          { label:'ç¡®è®¤å‡»æ€', fn: doWolfKillHuman },
          { label:'æ”¾å¼ƒå‡»æ€', fn: () => { G.wolfKill=null; advNight(); } }
        ]);
      });
    } else {
      // AI wolves act
      aiWolfKill();
      advNight();
    }
  } else if (step === 'seer') {
    if (p.alive && p.role === 'seer') {
      renderPlayers(true, [p.id]);
      setAction('ğŸ”® é¢„è¨€å®¶æŸ¥éªŒ', 'é€‰æ‹©ä¸€åç©å®¶æŸ¥éªŒå…¶èº«ä»½ï¼ˆä¸èƒ½é€‰è‡ªå·±ï¼‰', [
        { label:'ç¡®è®¤æŸ¥éªŒ', fn: doSeerHuman },
        { label:'è·³è¿‡', fn: advNight }
      ]);
    } else {
      aiSeer();
      advNight();
    }
  } else if (step === 'witch') {
    if (p.alive && p.role === 'witch') {
      doWitchHuman();
    } else {
      aiWitch();
      advNight();
    }
  } else if (step === 'guard') {
    if (p.alive && p.role === 'guard') {
      renderPlayers(true, [p.id]);
      setAction('ğŸ›¡ï¸ å®ˆå«å®ˆæŠ¤', 'é€‰æ‹©ä¸€åç©å®¶è¿›è¡Œå®ˆæŠ¤ï¼ˆä¸èƒ½è¿ç»­å®ˆæŠ¤åŒä¸€äººï¼‰', [
        { label:'ç¡®è®¤å®ˆæŠ¤', fn: doGuardHuman },
        { label:'è·³è¿‡', fn: advNight }
      ]);
    } else {
      aiGuard();
      advNight();
    }
  } else {
    resolveNight();
  }
}

function advNight() {
  G.nightPhase++;
  setTimeout(runNightPhase, 100);
}

// AI Actions
function aiWolfKill() {
  const wolves = G.players.filter(x=>x.alive&&x.role==='wolf');
  const targets = G.players.filter(x=>x.alive&&x.role!=='wolf');
  if (targets.length === 0) return;
  // Prefer to kill seer/witch/guard if known (simplified: random with weight)
  const priority = targets.filter(x=>['seer','witch','guard','hunter'].includes(x.role));
  G.wolfKill = (priority.length>0 && Math.random()<0.5) ? rnd(priority).id : rnd(targets).id;
}

function aiSeer() {
  // AI seer checks a random unchecked player
  const seer = G.players.find(x=>x.alive&&x.role==='seer'&&!x.isHuman);
  if (!seer) return;
  const unchecked = G.players.filter(x=>x.alive&&x.id!==seer.id&&!x.seerChecked);
  if (unchecked.length===0) return;
  const target = rnd(unchecked);
  target.seerChecked = true;
  // seer knows - this doesn't affect UI for player unless player is seer
}

function aiWitch() {
  const witch = G.players.find(x=>x.alive&&x.role==='witch'&&!x.isHuman);
  if (!witch) return;
  // Use save if wolf killed someone and haven't used save
  if (!G.witchUsedSave && G.wolfKill!==null && Math.random()<0.7) {
    G.witchSave = true;
    G.witchUsedSave = true;
  } else if (!G.witchUsedPoison && G.round > 1 && Math.random()<0.3) {
    const targets = G.players.filter(x=>x.alive&&x.id!==witch.id);
    if (targets.length>0) {
      const wolves = targets.filter(x=>x.role==='wolf');
      // Witch doesn't know wolves perfectly - random
      G.witchPoison = rnd(targets).id;
      G.witchUsedPoison = true;
      G.witchPoisoned = true;
    }
  }
}

function aiGuard() {
  const guard = G.players.find(x=>x.alive&&x.role==='guard'&&!x.isHuman);
  if (!guard) return;
  const candidates = G.players.filter(x=>x.alive&&x.id!==G.guardLastProtect);
  if (candidates.length===0) return;
  G.guardProtect = rnd(candidates).id;
  G.guardLastProtect = G.guardProtect;
}

// Human Actions
function doWolfKillHuman() {
  if (G.selectedTarget===null) { flashAction('è¯·å…ˆç‚¹å‡»ä¸€åç›®æ ‡ç©å®¶ï¼'); return; }
  const tgt = G.players[G.selectedTarget];
  if (!tgt.alive || tgt.role==='wolf') { flashAction('ä¸èƒ½é€‰æ‹©è‡ªå·±æˆ–ç‹¼é˜Ÿå‹ï¼'); return; }
  G.wolfKill = G.selectedTarget;
  clearSelection();
  advNight();
}

function doSeerHuman() {
  if (G.selectedTarget===null) { flashAction('è¯·å…ˆé€‰æ‹©è¦æŸ¥éªŒçš„ç©å®¶ï¼'); return; }
  const tgt = G.players[G.selectedTarget];
  if (!tgt.alive || tgt.id===G.humanIdx) { flashAction('ä¸èƒ½æŸ¥éªŒè‡ªå·±ï¼'); return; }
  const isWolf = tgt.role === 'wolf';
  const result = isWolf ? 'ğŸ”´ ç‹¼äºº' : 'ğŸ”µ å¥½äºº';
  showNightOverlay('ğŸ”® æŸ¥éªŒç»“æœ',
    `${tgt.name} çš„èº«ä»½æ˜¯ï¼š`,
    true,
    advNight,
    `${result}`,
    `${tgt.name}`
  );
  clearSelection();
}

function doWitchHuman() {
  const killed = G.wolfKill !== null ? G.players[G.wolfKill] : null;
  const showSave = !G.witchUsedSave && killed;
  const showPoison = !G.witchUsedPoison;
  let desc = '';
  if (killed) desc += `ä»Šæ™š ${killed.name} è¢«ç‹¼äººå‡»æ€ã€‚`;
  else desc += 'ä»Šæ™šç‹¼äººæ²¡æœ‰å‡»æ€ä»»ä½•äººã€‚';
  if (showSave) desc += ` ä½ å¯ä»¥ä½¿ç”¨è§£è¯æ•‘æ´» ${killed.name}ã€‚`;
  if (showPoison) desc += ' ä½ å¯ä»¥ä½¿ç”¨æ¯’è¯æ¯’æ€ä»»æ„ç©å®¶ã€‚';

  // Show save/skip first
  if (showSave) {
    setAction('âš—ï¸ å¥³å·«è¡ŒåŠ¨', desc, [
      { label:`ğŸ’Š ä½¿ç”¨è§£è¯æ•‘ ${killed.name}`, fn: () => { G.witchSave=true; G.witchUsedSave=true; addSystemLog(`å¥³å·«ä½¿ç”¨è§£è¯æ•‘äº† ${killed.name}`); doWitchPoison(); } },
      { label:'ä¸ä½¿ç”¨è§£è¯', fn: doWitchPoison },
    ]);
    updateSkillRes();
  } else {
    doWitchPoison();
  }
}

function doWitchPoison() {
  if (G.witchUsedPoison) { advNight(); return; }
  renderPlayers(true, [G.humanIdx]);
  setAction('âš—ï¸ å¥³å·« Â· æ¯’è¯', 'å¯ä»¥é€‰æ‹©æ¯’æ€ä¸€åç©å®¶ï¼ˆåŒ…æ‹¬è‡ªå·±å¤–çš„ä»»æ„ç©å®¶ï¼‰ï¼Œæˆ–ä¸ä½¿ç”¨æ¯’è¯ã€‚', [
    { label:'â˜ ï¸ ä½¿ç”¨æ¯’è¯', fn: () => {
      if (G.selectedTarget===null) { flashAction('è¯·å…ˆé€‰æ‹©æ¯’æ€ç›®æ ‡ï¼'); return; }
      G.witchPoison = G.selectedTarget; G.witchUsedPoison = true; G.witchPoisoned = true;
      addSystemLog(`å¥³å·«ä½¿ç”¨æ¯’è¯...`);
      clearSelection(); advNight();
    }},
    { label:'ä¸ä½¿ç”¨æ¯’è¯', fn: advNight },
  ]);
  updateSkillRes();
}

function doGuardHuman() {
  if (G.selectedTarget===null) { flashAction('è¯·å…ˆé€‰æ‹©è¦å®ˆæŠ¤çš„ç©å®¶ï¼'); return; }
  if (G.selectedTarget===G.guardLastProtect) { flashAction('ä¸èƒ½è¿ç»­ä¸¤å¤œå®ˆæŠ¤åŒä¸€äººï¼'); return; }
  G.guardProtect = G.selectedTarget;
  G.guardLastProtect = G.selectedTarget;
  clearSelection();
  advNight();
}

// ===== RESOLVE NIGHT =====
function resolveNight() {
  G.nightDeaths = [];
  const killed = G.wolfKill;

  if (killed !== null) {
    const savedByWitch = G.witchSave;
    const savedByGuard = G.guardProtect === killed;
    if (!savedByWitch && !savedByGuard) {
      G.nightDeaths.push(killed);
    }
  }

  // Witch poison - can die even if guard
  if (G.witchPoison !== null && !G.nightDeaths.includes(G.witchPoison)) {
    G.nightDeaths.push(G.witchPoison);
  }

  G.nightDeaths.forEach(id => G.players[id].alive = false);

  const humanDied = G.nightDeaths.includes(G.humanIdx);
  const deathNames = G.nightDeaths.map(id => G.players[id].name);
  const msg = G.nightDeaths.length === 0
    ? 'â˜€ï¸ å¹³å®‰å¤œï¼ä»Šæ™šæ²¡æœ‰ç©å®¶æ­»äº¡ã€‚'
    : `â˜€ï¸ é»æ˜æ¥ä¸´ã€‚${deathNames.join('ã€')} å€’åœ¨äº†é»‘å¤œä¹‹ä¸­ã€‚`;

  addSystemLog(msg);

  // Check hunter night death
  const nightHunter = G.nightDeaths.find(id => G.players[id].role==='hunter');
  // Hunter can't shoot if poisoned
  const hunterPoisoned = nightHunter !== undefined && G.witchPoison === nightHunter && G.witchPoisoned;

  if (checkWin()) return;

  if (nightHunter !== undefined && !hunterPoisoned) {
    G.hunterPending = nightHunter;
    beginDay(msg, true);
  } else {
    beginDay(msg, false);
  }
}

// ===== DAY PHASE =====
function beginDay(dawnMsg, hasHunter) {
  G.phase = 'day';
  G.selectedTarget = null;
  updateHeader();
  renderPlayers();
  clearAction();

  // Show dawn system message
  addSystemLog(`â”â”â”â” ç¬¬ ${G.round} å¤© â”â”â”â”`);

  // AI speeches
  setTimeout(() => runDayDiscussion(hasHunter), 300);
}

function runDayDiscussion(hasHunter) {
  const human = G.players[G.humanIdx];
  const alivePlayers = G.players.filter(p=>p.alive&&!p.isHuman);
  let delay = 0;

  alivePlayers.forEach(p => {
    delay += 800 + Math.random()*600;
    setTimeout(() => {
      const speeches = p.role==='wolf' ? WOLF_SPEECHES_DAY : GOOD_SPEECHES_DAY;
      const pool = rnd(speeches);
      let speech = rnd(pool);
      // Fill in template
      const others = G.players.filter(x=>x.alive&&x.id!==p.id);
      if (others.length>0) speech = speech.replace('{0}', rnd(others).seat);
      addSpeech(p, speech);
    }, delay);
  });

  // After all speeches, show action to human
  delay += 600;
  setTimeout(() => {
    if (hasHunter) {
      handleHunter(G.hunterPending, false);
    } else {
      if (human.alive) showVoteAction();
      else watchVote();
    }
  }, delay);
}

function showVoteAction() {
  renderPlayers(true, [G.humanIdx]);
  setAction('âš”ï¸ ç™½å¤©æŠ•ç¥¨', 'å‘è¡¨æ„è§åï¼Œé€‰æ‹©ä¸€åç©å®¶è¿›è¡ŒæŠ•ç¥¨é©±é€ã€‚ç¥¨æ•°æœ€é«˜è€…å‡ºå±€ã€‚', [
    { label:'æŠ•ç¥¨é©±é€', fn: doVoteHuman },
    { label:'å¼ƒç¥¨', fn: () => { addSpeech(G.players[G.humanIdx], 'æˆ‘é€‰æ‹©å¼ƒç¥¨ã€‚'); doAIVotes(); }},
  ]);
}

function watchVote() {
  setAction('ğŸ’€ ä½ å·²æ­»äº¡', 'ä½ åªèƒ½æ—è§‚æœ¬å±€æ¸¸æˆ...', []);
  doAIVotes();
}

function doVoteHuman() {
  if (G.selectedTarget===null) { flashAction('è¯·å…ˆé€‰æ‹©æŠ•ç¥¨ç›®æ ‡ï¼'); return; }
  const tgt = G.players[G.selectedTarget];
  if (!tgt.alive) { flashAction('è¯¥ç©å®¶å·²å‡ºå±€ï¼'); return; }
  addSpeech(G.players[G.humanIdx], `æˆ‘æŠ•ç¥¨é©±é€ ${tgt.seat}å· ${tgt.name}ï¼`);
  clearSelection();
  doAIVotes(G.selectedTarget);
}

function doAIVotes(humanVote) {
  // Collect AI votes
  const alive = G.players.filter(p=>p.alive);
  const voteMap = {};
  alive.forEach(p=>{
    let tgt;
    if (p.isHuman) {
      if (humanVote!==undefined) tgt=humanVote; else return;
    } else if (p.role==='wolf') {
      // Wolves vote for non-wolves, prefer key roles
      const good = G.players.filter(x=>x.alive&&x.role!=='wolf'&&x.id!==p.id);
      if (!good.length) return;
      tgt = rnd(good).id;
    } else {
      // Good AI votes for wolves sometimes, or random
      const suspects = G.players.filter(x=>x.alive&&x.id!==p.id);
      if (!suspects.length) return;
      // 40% chance to correctly vote wolf
      const wolves = suspects.filter(x=>x.role==='wolf');
      tgt = (wolves.length>0&&Math.random()<0.4) ? rnd(wolves).id : rnd(suspects).id;
    }
    voteMap[tgt] = (voteMap[tgt]||0)+1;
  });

  // AI speech votes
  let delay = 0;
  G.players.filter(p=>p.alive&&!p.isHuman).forEach(p => {
    if (voteMap[p.id]!==undefined || true) {
      delay += 400;
      setTimeout(()=>{
        // Find who this player voted for
        // (simplified: just show generic)
      }, delay);
    }
  });

  // Find result
  let maxVotes=0, maxId=null, tie=false;
  Object.entries(voteMap).forEach(([id,v])=>{
    if (v>maxVotes){maxVotes=v;maxId=parseInt(id);tie=false;}
    else if(v===maxVotes){tie=true;}
  });

  setTimeout(()=>{
    if (tie||maxId===null) {
      addSystemLog('âš–ï¸ æŠ•ç¥¨å¹³å±€ï¼ä»Šå¤©æ²¡æœ‰äººå‡ºå±€ã€‚');
      endDay();
    } else {
      const exiled = G.players[maxId];
      exiled.alive = false;
      const rd = ROLE_DATA[exiled.role];
      addSystemLog(`ğŸ—³ï¸ ${exiled.name} è¢«æŠ•ç¥¨é©±é€ï¼èº«ä»½æ­ç¤ºï¼š${rd.icon} ${rd.name}`);
      renderPlayers();

      if (checkWin()) return;

      // Hunter on exile?
      if (exiled.role==='hunter' && !G.witchPoisoned) {
        G.hunterPending = exiled.id;
        handleHunter(exiled.id, true);
      } else {
        endDay();
      }
    }
  }, delay + 600);
}

function handleHunter(hunterId, afterVote) {
  const hunter = G.players[hunterId];
  const isHuman = hunter.isHuman;
  addSystemLog(`ğŸ”« çŒäºº ${hunter.name} æ­»äº¡æ—¶å¯å¼€æªå¸¦èµ°ä¸€åç©å®¶ï¼`);

  if (isHuman && G.players[G.humanIdx].alive===false) {
    // Human hunter died
    renderPlayers(true, [hunterId]);
    setAction('ğŸ”« çŒäººæŠ€èƒ½', 'ä½ æ­»äº¡äº†ï¼å¯ä»¥å¼€æªå¸¦èµ°ä¸€åç©å®¶ã€‚', [
      { label:'å¼€æª', fn: () => {
        if (G.selectedTarget===null){flashAction('è¯·é€‰æ‹©ç›®æ ‡ï¼');return;}
        const tgt=G.players[G.selectedTarget];
        tgt.alive=false;
        addSystemLog(`ğŸ”« çŒäºº ${hunter.name} å¼€æªå¸¦èµ°äº† ${tgt.name}ï¼ˆ${ROLE_DATA[tgt.role].name}${ROLE_DATA[tgt.role].icon}ï¼‰`);
        renderPlayers();
        if(checkWin())return;
        endDay();
      }},
      { label:'ä¸å¼€æª', fn: endDay }
    ]);
  } else {
    // AI hunter
    const targets = G.players.filter(p=>p.alive&&p.id!==hunterId);
    if (targets.length>0) {
      const tgt = rnd(targets);
      tgt.alive = false;
      addSystemLog(`ğŸ”« çŒäºº ${hunter.name} å¼€æªå¸¦èµ°äº† ${tgt.name}ï¼ˆ${ROLE_DATA[tgt.role].name}ï¼‰`);
      renderPlayers();
      if(checkWin())return;
    }
    endDay();
  }
}

function endDay() {
  G.round++;
  G.hunterPending = null;
  clearAction();
  setTimeout(beginNight, 500);
}

// ===== WIN CHECK =====
function checkWin() {
  const wolves = G.players.filter(p=>p.alive&&p.role==='wolf').length;
  const good   = G.players.filter(p=>p.alive&&p.role!=='wolf').length;
  if (wolves===0) { showWin('village'); return true; }
  if (wolves>=good){ showWin('wolf'); return true; }
  return false;
}

function showWin(winner) {
  const human = G.players[G.humanIdx];
  const humanWon = (winner==='wolf') === (human.role==='wolf');
  const ws = document.getElementById('win-screen');
  ws.className = 'win-screen ' + (winner==='wolf' ? 'wolf-win' : 'village-win');
  document.getElementById('win-icon').textContent = winner==='wolf'?'ğŸº':'ğŸŒ…';
  document.getElementById('win-title').textContent = winner==='wolf'?'ç‹¼äººè·èƒœï¼':'æ‘æ°‘è·èƒœï¼';
  document.getElementById('win-sub').textContent = humanWon
    ? 'ğŸ‰ æ­å–œä½ ï¼ä½ èµ¢å¾—äº†è¿™ä¸€å±€ï¼' : 'ğŸ˜¢ å¾ˆé—æ†¾ï¼Œè¿™ä¸€å±€ä½ å¤±è´¥äº†...';

  const list = document.getElementById('reveal-list');
  list.innerHTML = '';
  G.players.forEach(p=>{
    const rd=ROLE_DATA[p.role];
    const chip=document.createElement('div');
    chip.className='reveal-chip';
    chip.textContent=`${p.alive?'âœ…':'âŒ'} ${p.name} Â· ${rd.name}${rd.icon}`;
    list.appendChild(chip);
  });
  ws.style.display='flex';
}

// ===== RENDER =====
function renderPlayers(selectable, excludeIds) {
  const ring = document.getElementById('players-ring');
  ring.innerHTML = '';
  G.players.forEach(p=>{
    const rd = ROLE_DATA[p.role];
    const div = document.createElement('div');
    let cls = 'player-card';
    if (p.isHuman) cls += ' is-you';
    if (!p.alive) cls += ' dead';
    if (selectable && p.alive && !(excludeIds||[]).includes(p.id)) cls += ' selectable';
    if (G.selectedTarget===p.id) cls += ' selected';
    div.className = cls;
    div.id = 'pc-'+p.id;

    const showRole = p.isHuman || !p.alive;
    div.innerHTML = `
      ${p.isHuman ? '<div class="you-badge">ä½ </div>' : ''}
      <div class="pc-seat">${p.seat}å·</div>
      <div class="pc-avatar">${p.avatar}</div>
      <div class="pc-name">${p.name}</div>
      ${showRole ? `<div class="pc-role-tag ${rd.team}">${rd.icon}${rd.name}</div>` : ''}
    `;

    if (selectable && p.alive && !(excludeIds||[]).includes(p.id)) {
      div.onclick = () => {
        G.selectedTarget = p.id;
        renderPlayers(selectable, excludeIds);
        const info = document.getElementById('action-desc');
        if (info) info.innerHTML = info.innerHTML.replace(/å·²é€‰æ‹©.*ï¼Ÿã€‚|/, '') + `<br><strong>å·²é€‰æ‹©ï¼š${p.seat}å· ${p.name}</strong>`;
      };
    }
    ring.appendChild(div);
  });
}

function addSpeech(player, text) {
  const log = document.getElementById('speech-log');
  const isHuman = player.isHuman;
  const isWolf = player.role==='wolf';
  const rd = ROLE_DATA[player.role];

  const div = document.createElement('div');
  div.className = `speech-item ${isHuman?'right':''} ${isWolf&&!player.alive?'wolf-talk':''}`;
  div.innerHTML = `
    ${!isHuman?`<div class="speech-avatar-sm">${player.avatar}</div>`:''}
    <div class="bubble">
      <div class="bubble-name">${player.seat}å· ${player.name}</div>
      ${text}
    </div>
    ${isHuman?`<div class="speech-avatar-sm">${player.avatar}</div>`:''}
  `;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function addSystemLog(msg) {
  const log = document.getElementById('speech-log');
  const div = document.createElement('div');
  div.className = 'speech-item system';
  div.innerHTML = `<div class="bubble">${msg}</div>`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

function setAction(title, desc, btns) {
  document.getElementById('action-title').textContent = 'â—ˆ ' + title;
  document.getElementById('action-desc').textContent = desc;
  const row = document.getElementById('action-btns');
  row.innerHTML = '';
  btns.forEach(b=>{
    const el=document.createElement('button');
    el.className = 'ink-btn';
    el.textContent = b.label;
    el.onclick = b.fn;
    row.appendChild(el);
  });
}

function clearAction() {
  document.getElementById('action-title').textContent = 'â—ˆ ç­‰å¾…ä¸­';
  document.getElementById('action-desc').textContent = '';
  document.getElementById('action-btns').innerHTML = '';
  renderPlayers();
}

function flashAction(msg) {
  const desc = document.getElementById('action-desc');
  const old = desc.textContent;
  desc.style.color = '#c0392b';
  desc.textContent = 'âš ï¸ ' + msg;
  setTimeout(()=>{ desc.style.color=''; desc.textContent=old; }, 1800);
}

function clearSelection() {
  G.selectedTarget = null;
}

function updateSkillRes() {
  const human = G.players[G.humanIdx];
  if (human.role !== 'witch') return;
  const el = document.getElementById('skill-res');
  el.style.display='flex';
  el.innerHTML = `
    <div class="skill-pip ${G.witchUsedSave?'used':''}">ğŸ’Šè§£è¯ ${G.witchUsedSave?'å·²ç”¨':'Ã—1'}</div>
    <div class="skill-pip ${G.witchUsedPoison?'used':''}">â˜ ï¸æ¯’è¯ ${G.witchUsedPoison?'å·²ç”¨':'Ã—1'}</div>
  `;
}

function updateHeader() {
  const ind = document.getElementById('phase-indicator');
  const badge = document.getElementById('round-badge');
  if (G.phase==='night') {
    ind.textContent = 'ğŸŒ‘ é»‘å¤œ';
    ind.className = 'phase-indicator night';
    badge.textContent = `ç¬¬ ${G.round} å¤œ`;
  } else {
    ind.textContent = 'â˜€ï¸ ç™½å¤©';
    ind.className = 'phase-indicator day';
    badge.textContent = `ç¬¬ ${G.round} å¤©`;
  }
}

// ===== NIGHT OVERLAY =====
let nightOverlayCb = null;
function showNightOverlay(title, msg, showSecret, cb, secretVal, secretLabel) {
  document.getElementById('night-overlay-title').textContent = title;
  document.getElementById('night-overlay-msg').textContent = msg;
  const secretBox = document.getElementById('night-secret-box');
  if (showSecret) {
    secretBox.style.display='block';
    document.getElementById('night-secret-label').textContent = secretLabel||'ç»“æœ';
    document.getElementById('night-secret-value').textContent = secretVal||'';
  } else {
    secretBox.style.display='none';
  }
  nightOverlayCb = cb;
  document.getElementById('night-overlay').style.display='flex';
}

function nightOverlayNext() {
  document.getElementById('night-overlay').style.display='none';
  if (nightOverlayCb) nightOverlayCb();
  nightOverlayCb = null;
}

// ===== HELPERS =====
function shuffle(arr) {
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function rnd(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function fadeTransition(cb) {
  const overlay = document.getElementById('fade-overlay');
  overlay.classList.add('show');
  setTimeout(()=>{ cb(); overlay.classList.remove('show'); }, 400);
}

// ===== BIND ALL EVENTS HERE (no inline onclick) =====
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('diff-easy').addEventListener('click', () => setDiff('easy'));
  document.getElementById('diff-normal').addEventListener('click', () => setDiff('normal'));
  document.getElementById('diff-hard').addEventListener('click', () => setDiff('hard'));
  document.getElementById('btn-start').addEventListener('click', initGame);
  document.getElementById('btn-close-role').addEventListener('click', closeRoleReveal);
  document.getElementById('night-overlay-btn').addEventListener('click', nightOverlayNext);
  document.getElementById('btn-replay').addEventListener('click', () => {
    document.getElementById('win-screen').style.display = 'none';
    document.getElementById('speech-log').innerHTML = '';
    showScreen('s-title');
  });
});
</script>
</body>
</html>

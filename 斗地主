import React, { useState, useEffect } from 'react';
import { Moon, Sun, Skull, Eye, Shield, Users, MessageSquare, Scroll, AlertTriangle, RefreshCw, Sparkles, User, Zap, Sword, Heart, FlaskConical, Trash2 } from 'lucide-react';

const apiKey = ""; // Gemini API Key

const ROLES = {
  WEREWOLF: { name: '狼人', side: 'evil', icon: <Skull size={18} /> },
  VILLAGER: { name: '村民', side: 'good', icon: <User size={18} /> },
  SEER: { name: '预言家', side: 'good', icon: <Eye size={18} /> },
  WITCH: { name: '女巫', side: 'good', icon: <Zap size={18} /> },
  HUNTER: { name: '猎人', side: 'good', icon: <Sword size={18} /> }
};

const App = () => {
  const [gameState, setGameState] = useState('menu'); 
  const [players, setPlayers] = useState([]);
  const [dayCount, setDayCount] = useState(1);
  const [logs, setLogs] = useState([]);
  const [messages, setMessages] = useState([]);
  const [isThinking, setIsThinking] = useState(false);
  const [nightPhase, setNightPhase] = useState('none'); 
  const [lastKilledId, setLastKilledId] = useState(null);
  const [skills, setSkills] = useState({ savePotion: true, deathPotion: true, hasChecked: false });

  const addLog = (msg) => setLogs(prev => [`[${dayCount}] ${msg}`, ...prev].slice(0, 8));

  const initGame = () => {
    const godRoles = ['SEER', 'WITCH', 'HUNTER'];
    const userRole = godRoles[Math.floor(Math.random() * godRoles.length)];
    const remainingGods = godRoles.filter(r => r !== userRole);
    let otherRoles = ['WEREWOLF', 'WEREWOLF', 'VILLAGER', ...remainingGods];
    
    for (let i = otherRoles.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [otherRoles[i], otherRoles[j]] = [otherRoles[j], otherRoles[i]];
    }

    const newPlayers = [
      { id: 0, name: '你 (1号)', role: userRole, isAlive: true, isUser: true, personality: '暴躁老哥' },
      ...otherRoles.map((role, idx) => ({
        id: idx + 1,
        name: `${idx + 2}号`,
        role: role,
        isAlive: true,
        isUser: false,
        personality: ['毒舌狂魔', '杠精', '阴阳大师', '冷面杀手', '逻辑怪'][idx]
      }))
    ];

    setPlayers(newPlayers);
    setDayCount(1);
    setLogs([]);
    setMessages([{ from: '系统', text: `随机职位：你是【${ROLES[userRole].name}】。夜幕降临，准备开演。` }]);
    setSkills({ savePotion: true, deathPotion: true, hasChecked: false });
    setGameState('night');
    setNightPhase('werewolf');
    simulateWerewolfAction(newPlayers);
  };

  const simulateWerewolfAction = (currentPlayers) => {
    setTimeout(() => {
      const aliveGoods = currentPlayers.filter(p => p.isAlive && p.role !== 'WEREWOLF');
      const target = aliveGoods[Math.floor(Math.random() * aliveGoods.length)];
      setLastKilledId(target.id);
      
      const user = currentPlayers.find(p => p.isUser);
      if (user.role === 'SEER') setNightPhase('seer');
      else if (user.role === 'WITCH') setNightPhase('witch');
      else resolveMorning(target.id, currentPlayers);
    }, 1000); // 极速响应
  };

  const useSeerSkill = (id) => {
    if (skills.hasChecked) return;
    const target = players.find(p => p.id === id);
    addLog(`验人：${id+1}号是【${target.role === 'WEREWOLF' ? '狼' : '好人'}】。`);
    setSkills(prev => ({ ...prev, hasChecked: true }));
    setTimeout(() => resolveMorning(lastKilledId, players), 800);
  };

  const useWitchSkill = (action, targetId = null) => {
    let finalKilled = lastKilledId;
    if (action === 'save') {
      finalKilled = null;
      setSkills(prev => ({ ...prev, savePotion: false }));
      addLog("你大发慈悲救了人。");
    } else if (action === 'poison') {
      setSkills(prev => ({ ...prev, deathPotion: false }));
      addLog(`你毒死了${targetId+1}号，真狠。`);
    }
    setTimeout(() => resolveMorning(finalKilled, players), 800);
  };

  const resolveMorning = (killedId, currentPlayers) => {
    setNightPhase('none');
    setGameState('morning');
    const newPlayers = currentPlayers.map(p => p.id === killedId ? { ...p, isAlive: false } : p);
    setPlayers(newPlayers);
    addLog(killedId !== null ? `${killedId + 1}号死了。` : "昨晚是平安夜。");
    checkGameEnd(newPlayers);
  };

  const checkGameEnd = (currentPlayers) => {
    const wolves = currentPlayers.filter(p => p.isAlive && p.role === 'WEREWOLF');
    const goods = currentPlayers.filter(p => p.isAlive && p.role !== 'WEREWOLF');
    if (wolves.length === 0) { setGameState('result-good'); return true; }
    if (wolves.length >= goods.length) { setGameState('result-evil'); return true; }
    return false;
  };

  const handleDiscussion = async () => {
    setGameState('discussion');
    setIsThinking(true);
    
    // 并行生成发言，速度更快
    const aliveAIs = players.filter(p => p.isAlive && !p.isUser);
    const speechPromises = aliveAIs.map(async (p) => {
      const prompt = `你是一个玩狼人杀的${p.personality}。身份：${ROLES[p.role].name}。场上状态：${players.filter(x => x.isAlive).map(x => x.id+1).join(',')}号还活着。你非常毒舌，喜欢阴阳怪气。请发表一段30字内的犀利发言，可以泼脏水、带节奏、嘲讽别人。`;
      try {
        const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
        });
        const data = await resp.json();
        return { from: p.name, text: data.candidates?.[0]?.content?.parts?.[0]?.text || "一群菜鸡，过。" };
      } catch (e) {
        return { from: p.name, text: "网络不行，你们这帮狼真恶心。" };
      }
    });

    const results = await Promise.all(speechPromises);
    setMessages(prev => [...prev, ...results]);
    setIsThinking(false);
  };

  const handleVote = (id) => {
    const newPlayers = players.map(p => p.id === id ? { ...p, isAlive: false } : p);
    setPlayers(newPlayers);
    addLog(`${id + 1}号被大家踢了。`);
    if (checkGameEnd(newPlayers)) return;
    setDayCount(d => d + 1);
    setGameState('night');
    setNightPhase('werewolf');
    simulateWerewolfAction(newPlayers);
  };

  const PlayerItem = ({ p }) => (
    <div className={`p-3 rounded-xl border-2 transition-all flex flex-col items-center justify-center gap-1 ${p.isAlive ? (p.isUser ? 'border-blue-500 bg-blue-900/30' : 'border-stone-800 bg-stone-900') : 'opacity-30 grayscale border-stone-900'}`}>
      <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${p.isUser ? 'bg-blue-600' : 'bg-stone-800'}`}>
        {p.isAlive ? (p.isUser ? <User size={14} /> : p.id + 1) : <Skull size={14} />}
      </div>
      <span className="text-[10px] font-bold truncate w-full text-center">{p.name}</span>
      
      {p.isAlive && !p.isUser && (
        <div className="flex gap-1 mt-1 w-full">
          {gameState === 'voting' && <button onClick={() => handleVote(p.id)} className="flex-1 bg-red-800 text-[9px] py-1 rounded">放逐</button>}
          {gameState === 'night' && nightPhase === 'seer' && players[0].role === 'SEER' && <button onClick={() => useSeerSkill(p.id)} className="flex-1 bg-indigo-600 text-[9px] py-1 rounded">验尸</button>}
          {gameState === 'night' && nightPhase === 'witch' && players[0].role === 'WITCH' && <button onClick={() => useWitchSkill('poison', p.id)} disabled={!skills.deathPotion} className="flex-1 bg-purple-800 text-[9px] py-1 rounded">投毒</button>}
        </div>
      )}
    </div>
  );

  if (gameState === 'menu') return (
    <div className="min-h-screen bg-stone-950 flex flex-col items-center justify-center text-white p-4">
      <h1 className="text-6xl font-black text-red-700 mb-2 italic">KILLER AI</h1>
      <p className="text-stone-500 mb-10 tracking-[0.5em] text-xs"> 毒舌、阴阳、逻辑、屠杀 </p>
      <button onClick={initGame} className="bg-red-700 px-12 py-4 rounded-full font-black text-xl hover:scale-110 transition-transform shadow-2xl">
        进入阴阳村
      </button>
    </div>
  );

  return (
    <div className="h-screen bg-stone-950 text-stone-200 flex flex-col p-2 md:p-4 overflow-hidden">
      {/* 极简顶栏 */}
      <div className="flex justify-between items-center mb-2 bg-stone-900/80 p-3 rounded-2xl border border-stone-800">
        <div className="flex items-center gap-3">
          <div className={`p-2 rounded-lg ${gameState === 'night' ? 'text-indigo-400 bg-indigo-900/20' : 'text-orange-400 bg-orange-900/20'}`}>
            {gameState === 'night' ? <Moon size={20} /> : <Sun size={20} />}
          </div>
          <span className="text-sm font-black">DAY {dayCount} - {gameState === 'night' ? '深夜' : '议事'}</span>
        </div>
        <div className="flex items-center gap-2">
           <span className="text-xs text-stone-500 uppercase">My Role:</span>
           <span className="text-blue-400 font-black text-sm">{ROLES[players[0].role].name}</span>
        </div>
      </div>

      <div className="flex-1 flex gap-2 overflow-hidden">
        {/* 左侧：3个玩家 */}
        <div className="w-24 md:w-32 flex flex-col gap-2 shrink-0">
          {players.slice(0, 3).map(p => <PlayerItem key={p.id} p={p} />)}
        </div>

        {/* 中间：主战场 - 占据最大空间 */}
        <div className="flex-1 flex flex-col min-w-0 bg-stone-900/40 rounded-2xl border border-stone-800/50 relative overflow-hidden">
          {/* 女巫弹窗 */}
          {nightPhase === 'witch' && players[0].role === 'WITCH' && (
            <div className="absolute inset-0 bg-black/90 z-30 flex flex-col items-center justify-center p-4 text-center">
              <FlaskConical size={40} className="text-purple-500 mb-4" />
              <p className="text-sm mb-4">今晚死的是：<span className="text-red-500 font-bold">{lastKilledId !== null ? `${lastKilledId+1}号` : '没人'}</span></p>
              <div className="flex gap-3">
                <button onClick={() => useWitchSkill('save')} disabled={!skills.savePotion || lastKilledId === null} className="bg-green-800 px-4 py-2 rounded-xl text-xs font-bold">救人</button>
                <button onClick={() => useWitchSkill('none')} className="bg-stone-800 px-4 py-2 rounded-xl text-xs font-bold">由他去死</button>
              </div>
            </div>
          )}
